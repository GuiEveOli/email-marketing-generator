<!DOCTYPE html>
<html lang="pt-br">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Resultado - E-mail Gerado</title>
	<style>
		body { margin:0; font-family: Arial, Helvetica, sans-serif; height:100vh; display:flex; flex-direction:column; }
		.topbar { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between; }
		.topbar h2 { margin:0; font-size:16px; color:#333; }
		.iframe-wrap { flex:1; }
		iframe#preview { width:100%; height:100%; border:none; display:block; }

		/* Botão flutuante */
		.floating-download {
			position:fixed;
			right:20px;
			bottom:20px;
			z-index:10000;
			background:#ff0000;
			color:#fff;
			border:none;
			border-radius:50px;
			padding:14px 18px;
			font-weight:700;
			box-shadow: 0 8px 20px rgba(0,0,0,0.15);
			cursor:pointer;
			display:flex;
			gap:10px;
			align-items:center;
		}
		.floating-download:disabled { opacity:0.6; cursor:not-allowed; }
		.floating-download .icon { width:18px; height:18px; display:inline-block; }

		/* Pequeno badge informativo */
		.download-label { font-size:14px; }
	</style>
</head>
<body>
	<div class="topbar">
		<h2>Preview do E-mail Gerado</h2>
		<div>Use o botão para baixar o HTML completo</div>
	</div>

	<div class="iframe-wrap">
		<iframe id="preview" sandbox="allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts">{{ resultado_html|safe }}</iframe>
	</div>
    
	<button id="downloadBtn" class="floating-download" title="Baixar HTML">
		<svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 3v12" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 10l5 5 5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
		<span class="download-label">Baixar HTML</span>
	</button>

	<script>
		// Recebe o HTML gerado do servidor (serializado com tojson)
		const generatedHtml = {{ resultado_html|tojson | safe }};

		const previewIframe = document.getElementById('preview');
		// Coloca o HTML dentro do iframe para preview
		if (previewIframe) {
			try {
				previewIframe.srcdoc = generatedHtml;
			} catch (e) {
				// fallback: escrever no documento do iframe
				try {
					const doc = previewIframe.contentDocument || previewIframe.contentWindow.document;
					doc.open(); doc.write(generatedHtml); doc.close();
				} catch (err) {
					console.warn('Não foi possível definir srcdoc do iframe:', err);
				}
			}
		}

		const downloadBtn = document.getElementById('downloadBtn');

		function downloadHtml(filename = 'email_gerado.html') {
			try {
				const blob = new Blob([generatedHtml], { type: 'text/html;charset=utf-8' });
				const url = URL.createObjectURL(blob);
				const a = document.createElement('a');
				a.href = url;
				a.download = filename;
				document.body.appendChild(a);
				a.click();
				a.remove();
				URL.revokeObjectURL(url);
			} catch (err) {
				console.error('Erro ao gerar o download:', err);
				alert('Não foi possível baixar o arquivo. Veja o console para detalhes.');
			}
		}

		downloadBtn.addEventListener('click', function () {
			// Nome do arquivo com timestamp
			const now = new Date();
			const ts = now.toISOString().replace(/[:.]/g, '-');
			downloadHtml(`email_gerado_${ts}.html`);
		});
	</script>
</body>
</html>
