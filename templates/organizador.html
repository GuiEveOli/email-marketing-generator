<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Pastas</title>
    <!-- SheetJS (xlsx.js) para ler arquivos Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- JSZip.js para criar arquivos .zip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="organizador-page">

    <main>

        <header class="top-nav-organizador" style="padding: 8px 0;">
            <div class="nav-inner">
                <nav class="nav-links">
                    <a href="/" class="{% if current == '/' %}active{% endif %}">Hub</a>
                    <a href="/gerador" class="{% if current.startswith('/gerador') %}active{% endif %}">Gerador</a>
                    <a href="/skuconsult" class="{% if current.startswith('/skuconsult') %}active{% endif %}">SKU Consult</a>
                    <a href="/organizador" class="{% if current.startswith('/organizador') %}active{% endif %}">Organizador</a>
                </nav>
            </div>
        </header>


        <div class="container">
            <div class="card" style="padding: 20px 60px;">
                <h1 class="page-title" style="margin-bottom: 20px;">Organizador de Pastas</h1>
                
                <form class="form-group">
                    <!-- Passo 1: Upload do Excel -->
                    <div class="form-field">
                        <label for="excel_file" class="form-label">
                            <strong>1.</strong> Arquivo Excel (.xlsx)
                        </label>
                        <input type="file" id="excel_file" accept=".xlsx, .xls" class="file-input">
                        <small class="form-hint">Selecione o arquivo Excel com a estrutura de pastas e SKUs</small>
                    </div>

                    <!-- Grid para campos 2, 3 e 4 lado a lado -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                        
                        <!-- Passo 2: Nome da Coluna do Criativo -->
                        <div class="form-field">
                            <label for="creative_column" class="form-label">
                                <strong>2.</strong> Nome da Coluna do Criativo (N√≠vel 2)
                            </label>
                            <input 
                                type="text" 
                                id="creative_column" 
                                placeholder="Ex: Nome do Criativo, Pe√ßa, etc." 
                                class="input-field"
                            >
                        </div>

                        <!-- Passo 3: Nome da Coluna do SKU -->
                        <div class="form-field">
                            <label for="sku_column" class="form-label">
                                <strong>3.</strong> Nome da Coluna do SKU (opcional)
                            </label>
                            <input 
                                type="text" 
                                id="sku_column" 
                                placeholder="Ex: SKU, COD_PRODUTO, C√≥digo, etc." 
                                class="input-field"
                            >
                        </div>

                        <!-- Passo 4: Nome da Coluna de Vendas -->
                        <div class="form-field">
                            <label for="sales_column" class="form-label">
                                <strong>4.</strong>Coluna de Vendas (opcional)
                            </label>
                            <input 
                                type="text" 
                                id="sales_column" 
                                placeholder="Ex: Vendas, Quantidade, Total Vendido, etc." 
                                class="input-field"
                            >
                        </div>
                        
                    </div>

                    <!-- √Årea de Status e Erros -->
                    <div id="status" class="status-message" role="alert" style="display: none;"></div>

                    <!-- Passo 5: Bot√£o de A√ß√£o -->
                    <button type="button" id="process_button" class="btn btn-primary">
                        üöÄ Gerar Pastas (.zip)
                    </button>
                </form>
            </div>
        </div>
        
    </main>

    <script>
        // Pega os elementos do DOM
        const fileInput = document.getElementById('excel_file');
        const columnInput = document.getElementById('creative_column');
        const skuColumnInput = document.getElementById('sku_column');
        const salesColumnInput = document.getElementById('sales_column');
        const processButton = document.getElementById('process_button');
        const statusDiv = document.getElementById('status');

        // Adiciona o listener ao bot√£o
        processButton.addEventListener('click', handleProcessing);

        async function handleProcessing() {
            // Pega os inputs do usu√°rio
            const excelFile = fileInput.files[0];
            const creativeColumn = columnInput.value.trim();
            const skuColumn = skuColumnInput.value.trim();
            const salesColumn = salesColumnInput.value.trim();

            // --- 1. Valida√ß√£o ---
            if (!excelFile || !creativeColumn) {
                showStatus('Arquivo Excel e nome da coluna do criativo s√£o obrigat√≥rios.', true);
                return;
            }

            // Desabilita o bot√£o e mostra status
            setLoading(true, 'Lendo arquivo...');

            try {
                // --- 2. Fun√ß√µes de Normaliza√ß√£o (portadas do Python) ---

                /**
                 * Normaliza texto para correspond√™ncia de cabe√ßalho (min√∫sculo, sem acentos).
                 * Equivalente a `_norm` do Python.
                 */
                function _norm(s) {
                    s = String(s || '').trim().toLowerCase();
                    // Remove acentos (diacr√≠ticos)
                    return s.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
                }

                /**
                 * Limpa um nome para ser seguro como nome de arquivo/pasta.
                 * Equivalente a `safe` do Python.
                 */
                function safe(name) {
                    name = String(name || '').trim();
                    if (!name) return '';
                    
                    // Remove acentos
                    name = name.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
                    // Substitui / por -
                    name = name.replace(/\//g, '-');
                    // Remove caracteres inv√°lidos (mant√©m A-Z, a-z, 0-9, -, _, ., espa√ßo)
                    name = name.replace(/[^A-Za-z0-9\-\._ ]/g, '');
                    // Substitui m√∫ltiplos espa√ßos por um
                    name = name.replace(/\s+/g, ' ').trim();
                    // Limita o tamanho
                    return name.substring(0, 120);
                }

                /**
                 * Converte valor de vendas para n√∫mero
                 */
                function parseVendas(valor) {
                    if (typeof valor === 'number') return valor;
                    if (!valor) return 0;
                    
                    // Remove tudo que n√£o √© n√∫mero, ponto ou v√≠rgula
                    let numStr = String(valor).replace(/[^\d,.-]/g, '');
                    
                    // Substitui v√≠rgula por ponto
                    numStr = numStr.replace(',', '.');
                    
                    const num = parseFloat(numStr);
                    return isNaN(num) ? 0 : num;
                }

                /**
                 * Busca e baixa a imagem do produto via webscraping
                 * (mesmo m√©todo do gerador de emails)
                 */
                async function baixarImagemPorSKU(sku) {
                    try {
                        const response = await fetch('/api/buscar-e-baixar-imagem-produto', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ sku: sku })
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.warn(`Erro ao baixar imagem para SKU ${sku}:`, errorData.error || response.statusText);
                            return null;
                        }
                        
                        const blob = await response.blob();
                        
                        // Verifica se realmente √© uma imagem
                        if (blob.size === 0 || !blob.type.startsWith('image/')) {
                            console.warn(`SKU ${sku}: blob inv√°lido (tipo: ${blob.type}, tamanho: ${blob.size})`);
                            return null;
                        }
                        
                        return blob;
                    } catch (error) {
                        console.warn(`Erro ao processar imagem do SKU ${sku}:`, error);
                        return null;
                    }
                }

                /**
                 * Detecta a extens√£o da imagem a partir do blob
                 */
                function getExtensaoDoBlob(blob) {
                    const mimeToExt = {
                        'image/jpeg': 'jpg',
                        'image/jpg': 'jpg',
                        'image/png': 'png',
                        'image/gif': 'gif',
                        'image/webp': 'webp',
                        'image/bmp': 'bmp'
                    };
                    return mimeToExt[blob.type] || 'jpg';
                }

                // --- 3. Leitura do Excel (usando SheetJS) ---
                const data = await excelFile.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                // Converte para array de arrays (header: 1) para ser similar ao iter_rows
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (rows.length < 2) {
                    throw new Error('Planilha est√° vazia ou n√£o tem cabe√ßalho.');
                }

                // --- 4. Processamento dos Cabe√ßalhos ---
                setLoading(true, 'Processando colunas...');
                
                const headers = rows[0].map(h => String(h || '').trim());
                const headerNormMap = new Map(headers.map(h => [_norm(h), h]));

                // 4a. Resolve coluna do Criativo
                const normCreativeColumn = _norm(creativeColumn);
                let colCreativeName = headerNormMap.get(normCreativeColumn);

                // Tenta correspond√™ncia parcial (se n√£o achar exato)
                if (!colCreativeName) {
                    for (const [normHeader, origHeader] of headerNormMap.entries()) {
                        if (normHeader.includes(normCreativeColumn)) {
                            colCreativeName = origHeader;
                            break;
                        }
                    }
                }

                if (!colCreativeName) {
                    throw new Error(`Coluna do Criativo n√£o encontrada: "${creativeColumn}"`);
                }

                // 4b. Resolve coluna do SKU (se fornecida)
                let colSkuName = null;
                let idxSku = -1;
                if (skuColumn) {
                    const normSkuColumn = _norm(skuColumn);
                    colSkuName = headerNormMap.get(normSkuColumn);

                    // Tenta correspond√™ncia parcial
                    if (!colSkuName) {
                        for (const [normHeader, origHeader] of headerNormMap.entries()) {
                            if (normHeader.includes(normSkuColumn)) {
                                colSkuName = origHeader;
                                break;
                            }
                        }
                    }

                    if (colSkuName) {
                        idxSku = headers.indexOf(colSkuName);
                        console.log(`‚úì Coluna SKU encontrada: "${colSkuName}" (√≠ndice ${idxSku})`);
                    } else {
                        console.warn(`‚ö† Coluna SKU "${skuColumn}" n√£o encontrada. Imagens n√£o ser√£o baixadas.`);
                    }
                }

                // 4c. Resolve coluna de Vendas (se fornecida)
                let colSalesName = null;
                let idxSales = -1;
                if (salesColumn) {
                    const normSalesColumn = _norm(salesColumn);
                    colSalesName = headerNormMap.get(normSalesColumn);

                    // Tenta correspond√™ncia parcial
                    if (!colSalesName) {
                        for (const [normHeader, origHeader] of headerNormMap.entries()) {
                            if (normHeader.includes(normSalesColumn)) {
                                colSalesName = origHeader;
                                break;
                            }
                        }
                    }

                    if (colSalesName) {
                        idxSales = headers.indexOf(colSalesName);
                        console.log(`‚úì Coluna Vendas encontrada: "${colSalesName}" (√≠ndice ${idxSales})`);
                    } else {
                        console.warn(`‚ö† Coluna Vendas "${salesColumn}" n√£o encontrada. Todos os produtos ser√£o processados.`);
                    }
                }

                // 4d. Tenta detectar coluna "Din√¢mica"
                const dinamicaAliases = ['dinamica', 'din√¢mica', 'categoria', 'campanha', 'grupo', 'etiqueta', 'pasta'];
                let colDinamicaName = null;
                for (const alias of dinamicaAliases) {
                    if (headerNormMap.has(alias)) {
                        colDinamicaName = headerNormMap.get(alias);
                        break;
                    }
                }

                // 4e. Pega os √≠ndices das colunas
                const idxCreative = headers.indexOf(colCreativeName);
                const idxDinamica = colDinamicaName ? headers.indexOf(colDinamicaName) : -1;

                // --- 5. Agrupamento e Filtragem por Pasta (N√≠vel 2) ---
                setLoading(true, 'Agrupando produtos por pasta...');
                
                // Agrupa os produtos por pasta (dinamica + criativo)
                const produtosPorPasta = new Map();
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;

                    const creativeVal = safe(row[idxCreative]);
                    if (!creativeVal) continue;

                    const dinamicaVal = (idxDinamica !== -1 ? safe(row[idxDinamica]) : '').toUpperCase();

                    // Monta a chave da pasta (nivel1 + nivel2)
                    let pastaKey = '';
                    if (dinamicaVal) {
                        pastaKey += dinamicaVal + '/';
                    }
                    pastaKey += creativeVal + '/';

                    // Pega o SKU e vendas
                    const sku = (idxSku !== -1 && row[idxSku]) ? String(row[idxSku]).trim() : null;
                    const vendas = (idxSales !== -1 && row[idxSales] !== undefined) ? parseVendas(row[idxSales]) : 0;

                    // Se n√£o tem SKU, pula
                    if (!sku) continue;

                    // Adiciona ao grupo
                    if (!produtosPorPasta.has(pastaKey)) {
                        produtosPorPasta.set(pastaKey, []);
                    }

                    produtosPorPasta.get(pastaKey).push({
                        sku,
                        vendas,
                        pastaKey,
                        rowIndex: i
                    });
                }

                // --- 6. Seleciona Top 5 por Pasta (se coluna de vendas foi informada) ---
                const produtosSelecionados = [];
                const MAX_POR_PASTA = 5;

                for (const [pastaKey, produtos] of produtosPorPasta.entries()) {
                    let produtosOrdenados = produtos;

                    // Se temos coluna de vendas, ordena por vendas (decrescente)
                    if (idxSales !== -1) {
                        produtosOrdenados = produtos.sort((a, b) => b.vendas - a.vendas);
                    }

                    // Pega no m√°ximo 5
                    const top5 = produtosOrdenados.slice(0, MAX_POR_PASTA);
                    
                    console.log(`üìÅ ${pastaKey}: ${produtos.length} produtos ‚Üí Top ${top5.length} selecionados`);
                    if (idxSales !== -1 && top5.length > 0) {
                        console.log(`   Vendas: [${top5.map(p => p.vendas).join(', ')}]`);
                    }

                    produtosSelecionados.push(...top5);
                }

                console.log(`\n‚úì Total de produtos selecionados: ${produtosSelecionados.length}`);

                // --- 7. Cria√ß√£o da Estrutura do ZIP ---
                setLoading(true, 'Criando estrutura de pastas...');
                
                const zip = new JSZip();
                const createdPaths = new Set();
                
                // Cria todas as pastas √∫nicas
                for (const produto of produtosSelecionados) {
                    if (!createdPaths.has(produto.pastaKey)) {
                        zip.file(produto.pastaKey + '.keep', '');
                        createdPaths.add(produto.pastaKey);
                    }
                }

                if (createdPaths.size === 0) {
                    throw new Error('Nenhuma pasta foi criada. Verifique sua planilha e o nome da coluna.');
                }

                // --- 8. Download das Imagens ---
                let totalImagens = 0;
                let imagensBaixadas = 0;
                let imagensErro = 0;

                if (produtosSelecionados.length > 0 && idxSku !== -1) {
                    totalImagens = produtosSelecionados.length;
                    setLoading(true, `Baixando imagens via webscraping... (0/${totalImagens})`);
                    
                    const BATCH_SIZE = 3; // Processa 3 imagens por vez
                    
                    for (let i = 0; i < produtosSelecionados.length; i += BATCH_SIZE) {
                        const batch = produtosSelecionados.slice(i, i + BATCH_SIZE);
                        
                        // Processa o lote em paralelo
                        const promises = batch.map(async (produto) => {
                            try {
                                const blob = await baixarImagemPorSKU(produto.sku);
                                
                                if (!blob) {
                                    console.warn(`‚úó Erro ao baixar imagem para SKU ${produto.sku}`);
                                    return { success: false, sku: produto.sku };
                                }

                                const extensao = getExtensaoDoBlob(blob);
                                const nomeArquivo = `${safe(produto.sku)}.${extensao}`;
                                zip.file(produto.pastaKey + nomeArquivo, blob);
                                console.log(`‚úì Imagem baixada: ${produto.pastaKey}${nomeArquivo}`);
                                return { success: true, sku: produto.sku };
                                
                            } catch (error) {
                                console.error(`‚úó Erro ao processar SKU ${produto.sku}:`, error);
                                return { success: false, sku: produto.sku };
                            }
                        });

                        // Aguarda o lote completar
                        const results = await Promise.all(promises);
                        
                        // Conta sucessos e erros
                        results.forEach(result => {
                            if (result.success) {
                                imagensBaixadas++;
                            } else {
                                imagensErro++;
                            }
                        });

                        // Atualiza o status
                        const processadas = imagensBaixadas + imagensErro;
                        setLoading(true, `Baixando imagens via webscraping... (${processadas}/${totalImagens}) - ‚úì ${imagensBaixadas} | ‚úó ${imagensErro}`);
                    }
                }

                // --- 9. Gera√ß√£o e Download do .zip ---
                setLoading(true, 'Gerando arquivo .zip...');

                // Define o nome do arquivo zip
                const origName = excelFile.name.split('.').slice(0, -1).join('.');
                const zipNameBase = safe(origName) || 'pastas';
                const zipFileName = `${zipNameBase}.zip`;

                const content = await zip.generateAsync({ type: 'blob' });

                // Cria um link tempor√°rio para o download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = zipFileName;
                
                // Adiciona, clica e remove o link
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Limpa o objeto URL
                URL.revokeObjectURL(link.href);
                
                let mensagemSucesso = `Sucesso! ${createdPaths.size} pastas criadas`;
                if (idxSales !== -1) {
                    mensagemSucesso += ` (Top ${MAX_POR_PASTA} por pasta)`;
                }
                mensagemSucesso += ` em ${zipFileName}`;
                
                if (totalImagens > 0) {
                    mensagemSucesso += `\n${imagensBaixadas} imagens baixadas`;
                    if (imagensErro > 0) {
                        mensagemSucesso += `, ${imagensErro} com erro`;
                    }
                }
                showStatus(mensagemSucesso, false);

            } catch (error) {
                console.error('Erro no processamento:', error);
                showStatus(`Erro: ${error.message}`, true);
            } finally {
                // Reabilita o bot√£o
                setLoading(false);
            }
        }

        /**
         * Controla o estado de carregamento do bot√£o e da mensagem de status.
         */
        function setLoading(isLoading, message = '') {
            processButton.disabled = isLoading;
            if (isLoading) {
                processButton.textContent = message || 'Processando...';
                statusDiv.textContent = message;
                statusDiv.className = 'status-message status-info';
                statusDiv.style.display = 'block';
            } else {
                processButton.textContent = 'üöÄ Gerar Pastas (.zip)';
            }
        }

        /**
         * Mostra uma mensagem de status final (erro ou sucesso).
         */
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'status-message status-error' : 'status-message status-success';
            statusDiv.style.display = 'block';
        }

    </script>
</body>
</html>
