<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Resultado - E-mail Gerado</title>
    <style>
        body { margin:0; font-family: Arial, Helvetica, sans-serif; height:100vh; display:flex; flex-direction:column; }
        .topbar { background:#f8f9fa; padding:12px 16px; border-bottom:1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between; }
        .topbar h2 { margin:0; font-size:16px; color:#333; }
        .iframe-wrap { flex:1; }
        iframe#preview { width:100%; height:100%; border:none; display:block; }

        /* Botões flutuantes */
        .floating-buttons {
            position:fixed;
            right:20px;
            bottom:20px;
            z-index:10000;
            display:flex;
            flex-direction:column;
            gap:12px;
        }

        .floating-btn {
            background:#ff0000;
            color:#fff;
            border:none;
            border-radius:50px;
            padding:14px 18px;
            font-weight:700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            cursor:pointer;
            display:flex;
            gap:10px;
            align-items:center;
            text-decoration:none;
            font-size:14px;
            transition:all 0.3s ease;
        }

        .floating-btn:hover {
            background:#e60000;
            transform:translateY(-2px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.2);
        }

        .floating-btn:disabled { opacity:0.6; cursor:not-allowed; }
        .floating-btn .icon { width:18px; height:18px; display:inline-block; }

        .btn-secondary {
            background:#6c757d;
        }

        .btn-secondary:hover {
            background:#545b62;
        }

        .btn-info {
            background:#17a2b8;
        }

        .btn-info:hover {
            background:#138496;
        }

        /* Modal para mostrar HTML */
        .modal {
            display:none;
            position:fixed;
            z-index:20000;
            left:0;
            top:0;
            width:100%;
            height:100%;
            background-color:rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color:#fff;
            margin:2% auto;
            padding:20px;
            border-radius:8px;
            width:90%;
            height:85%;
            position:relative;
            display:flex;
            flex-direction:column;
        }

        .modal-header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin-bottom:20px;
            padding-bottom:10px;
            border-bottom:1px solid #e9ecef;
        }

        .close {
            color:#aaa;
            float:right;
            font-size:28px;
            font-weight:bold;
            cursor:pointer;
        }

        .close:hover {
            color:#000;
        }

        .html-content {
            flex:1;
            overflow:auto;
            background:#f8f9fa;
            padding:15px;
            border-radius:5px;
            font-family:monospace;
            font-size:12px;
            white-space:pre-wrap;
            border:1px solid #e9ecef;
        }

        .copy-btn {
            margin-top:10px;
            padding:8px 16px;
            background:#28a745;
            color:#fff;
            border:none;
            border-radius:4px;
            cursor:pointer;
        }

        .copy-btn:hover {
            background:#218838;
        }

        .erro-container {
            display: none;
            padding: 40px;
            text-align: center;
            background: #f8d7da;
            color: #721c24;
            border-radius: 8px;
            margin: 20px;
        }

        .erro-container h2 {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="topbar">
        <h2>Preview do E-mail Gerado</h2>
        <div>Use os botões para baixar, ver código ou gerar novo e-mail</div>
    </div>

    <div class="erro-container" id="erroContainer">
        <h2>⚠️ Nenhum email foi gerado</h2>
        <p>Por favor, volte e gere um novo email.</p>
        <a href="/" class="floating-btn btn-secondary" style="display: inline-flex; margin-top: 20px;">
            Voltar ao Gerador
        </a>
    </div>

    <div class="iframe-wrap" id="iframeWrap">
        <iframe id="preview" sandbox="allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts"></iframe>
    </div>
    
    <!-- Botões flutuantes -->
    <div class="floating-buttons" id="floatingButtons">
        <!-- Botão para voltar/gerar novo -->
        <a href="/" class="floating-btn btn-secondary" title="Gerar Novo E-mail">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M3 12l9-9 9 9M12 3v18" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M12 21l-9-9 9-9" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Gerar Novo</span>
        </a>

        <!-- Botão para ver HTML -->
        <button id="viewHtmlBtn" class="floating-btn btn-info" title="Ver Código HTML">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M16 18l6-6-6-6M8 6l-6 6 6 6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Ver HTML</span>
        </button>

        <!-- Botão para baixar -->
        <button id="downloadBtn" class="floating-btn" title="Baixar HTML">
            <svg class="icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 3v12" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M7 10l5 5 5-5" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <span>Baixar HTML</span>
        </button>
    </div>

    <!-- Modal para mostrar HTML -->
    <div id="htmlModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Código HTML do E-mail</h3>
                <span class="close">&times;</span>
            </div>
            <div class="html-content" id="htmlContent"></div>
            <button class="copy-btn" id="copyBtn">Copiar HTML</button>
        </div>
    </div>

    <script>
        // Recupera o HTML gerado do sessionStorage
        const generatedHtml = sessionStorage.getItem('emailGerado');

        if (!generatedHtml) {
            // Se não houver HTML, mostra erro
            document.getElementById('erroContainer').style.display = 'block';
            document.getElementById('iframeWrap').style.display = 'none';
            document.getElementById('floatingButtons').style.display = 'none';
        } else {
            // Carrega o HTML no iframe
            const previewIframe = document.getElementById('preview');
            
            try {
                previewIframe.srcdoc = generatedHtml;
            } catch (e) {
                // fallback: escrever no documento do iframe
                try {
                    const doc = previewIframe.contentDocument || previewIframe.contentWindow.document;
                    doc.open(); 
                    doc.write(generatedHtml); 
                    doc.close();
                } catch (err) {
                    console.warn('Não foi possível definir srcdoc do iframe:', err);
                }
            }
        }

        const downloadBtn = document.getElementById('downloadBtn');
        const viewHtmlBtn = document.getElementById('viewHtmlBtn');
        const htmlModal = document.getElementById('htmlModal');
        const htmlContent = document.getElementById('htmlContent');
        const closeModal = document.querySelector('.close');
        const copyBtn = document.getElementById('copyBtn');

        // Função para baixar HTML
        function downloadHtml(filename = 'email_gerado.html') {
            if (!generatedHtml) {
                alert('Nenhum email foi gerado!');
                return;
            }

            try {
                const blob = new Blob([generatedHtml], { type: 'text/html;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            } catch (err) {
                console.error('Erro ao gerar o download:', err);
                alert('Não foi possível baixar o arquivo. Veja o console para detalhes.');
            }
        }

        // Event listeners
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function () {
                const now = new Date();
                const ts = now.toISOString().replace(/[:.]/g, '-').substring(0, 19);
                downloadHtml(`email_gerado_${ts}.html`);
            });
        }

        if (viewHtmlBtn) {
            viewHtmlBtn.addEventListener('click', function () {
                if (!generatedHtml) {
                    alert('Nenhum email foi gerado!');
                    return;
                }
                htmlContent.textContent = generatedHtml;
                htmlModal.style.display = 'block';
            });
        }

        if (closeModal) {
            closeModal.addEventListener('click', function () {
                htmlModal.style.display = 'none';
            });
        }

        if (copyBtn) {
            copyBtn.addEventListener('click', function () {
                if (!generatedHtml) {
                    alert('Nenhum email foi gerado!');
                    return;
                }

                navigator.clipboard.writeText(generatedHtml).then(function() {
                    copyBtn.textContent = 'Copiado!';
                    copyBtn.style.background = '#28a745';
                    setTimeout(function() {
                        copyBtn.textContent = 'Copiar HTML';
                        copyBtn.style.background = '#28a745';
                    }, 2000);
                }).catch(function(err) {
                    console.error('Erro ao copiar:', err);
                    alert('Não foi possível copiar o HTML. Use Ctrl+C manualmente.');
                });
            });
        }

        // Fechar modal clicando fora dele
        window.addEventListener('click', function(event) {
            if (event.target === htmlModal) {
                htmlModal.style.display = 'none';
            }
        });

        // Fechar modal com ESC
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && htmlModal.style.display === 'block') {
                htmlModal.style.display = 'none';
            }
        });

        // Limpar sessionStorage ao sair da página de resultado
        window.addEventListener('beforeunload', function() {
            // Só limpa se estiver navegando para outra página (não refresh)
            if (performance.navigation.type !== performance.navigation.TYPE_RELOAD) {
                sessionStorage.removeItem('emailGerado');
            }
        });
    </script>
</body>
</html>
