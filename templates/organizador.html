<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Pastas</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    <style>
        :root {
            /* Palette de Cores Modernas */
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --secondary: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-header: #f8fafc;
            
            --text-main: #1e293b;
            --text-muted: #64748b;
            
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            
            --radius: 12px;
            --radius-sm: 6px;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            padding-bottom: 60px;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Layout Principal --- */
        .main-container {
            max-width: 1400px;
            margin: 40px auto;
            padding: 0 20px;
            display: grid;
            grid-template-columns: 380px 1fr; /* Coluna fixa e resto fluido */
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }
        }

        /* --- Estilo dos Cards (Container Branco) --- */
        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border);
            padding: 24px;
        }

        /* Card de Preview (Estilo Especial sem padding para cabe√ßalho full-width) */
        #preview_section {
            padding: 0;
            overflow: hidden; /* Para o border-radius funcionar com o header */
            display: flex;
            flex-direction: column;
        }

        .page-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: var(--text-main);
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        /* --- Formul√°rios --- */
        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-field {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .input-field, .file-input {
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 0.9rem;
            transition: all 0.2s;
            width: 100%;
            box-sizing: border-box;
            background: #fff;
        }

        .input-field:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .file-input {
            background: #f8fafc;
            cursor: pointer;
        }

        hr {
            border: 0;
            border-top: 1px solid var(--border);
            width: 100%;
            margin: 8px 0;
        }

        /* --- Bot√µes --- */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 20px;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
            font-size: 0.95rem;
            width: 100%;
        }

        .btn:active { transform: translateY(1px); }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 1px 2px rgba(37, 99, 235, 0.3);
        }
        .btn-primary:hover:not(:disabled) { background-color: var(--primary-hover); }

        .btn-secondary {
            background-color: white;
            border: 1px solid var(--border);
            color: var(--text-main);
        }
        .btn-secondary:hover:not(:disabled) { background-color: #f8fafc; border-color: #cbd5e1; }

        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* --- Mensagens de Status --- */
        .status-message {
            padding: 12px;
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            margin-top: 10px;
            line-height: 1.4;
            display: none;
        }
        .status-info { background: #eff6ff; color: #1e40af; border: 1px solid #dbeafe; }
        .status-success { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
        .status-error { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }

        /* --- Preview Header (NOVO DESIGN) --- */
        .preview-header {
            background: var(--bg-header);
            padding: 16px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-left h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
            color: black;
        }

        /* Badge de contador estilo p√≠lula */
        .count-badge {
            background-color: #e2e8f0;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 99px;
            letter-spacing: 0.5px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-divider {
            width: 1px;
            height: 24px;
            background-color: var(--border);
        }

        /* Toggle Switch (Social Media) */
        .toggle-control {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
        }
        .toggle-control input { display: none; }
        
        .toggle-track {
            width: 36px;
            height: 20px;
            background-color: #cbd5e1;
            border-radius: 20px;
            position: relative;
            transition: background-color 0.2s ease;
        }
        .toggle-indicator {
            width: 16px;
            height: 16px;
            background-color: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .toggle-control input:checked + .toggle-track { background-color: var(--primary); }
        .toggle-control input:checked + .toggle-track .toggle-indicator { transform: translateX(16px); }
        
        .toggle-text {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
        }
        .toggle-control:hover .toggle-text { color: var(--text-main); }

        /* Select Customizado */
        .sort-control {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .select-clean {
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 32px 6px 12px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-main);
            background-color: white;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748b' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 14px;
            transition: all 0.2s;
        }
        .select-clean:hover { border-color: #cbd5e1; }
        .select-clean:focus { outline: none; border-color: var(--primary); }

        /* Search Box Din√¢mico (JS) */
        #product_search_box {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            border: 1px solid var(--border);
            min-width: 200px;
        }

        /* --- Abas e Grid de Preview --- */
        .tabs-container {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            background: #fff;
        }

        .tab-btn {
            padding: 6px 16px;
            border: 1px solid var(--border);
            background: white;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-muted);
        }
        .tab-btn:hover { background: #f8fafc; color: var(--text-main); }
        .tab-btn.active {
            background: var(--text-main);
            color: white;
            border-color: var(--text-main);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 24px;
        }

        /* --- Cards de Produto --- */
        .preview-card {
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
            cursor: pointer;
            position: relative;
        }
        .preview-card:hover {
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .card-header-flex { display: flex; gap: 16px; }

        .card-img-box {
            width: 72px;
            height: 72px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
            border: 1px solid var(--border);
            position: relative;
        }
        .card-img-box img { width: 100%; height: 100%; object-fit: contain; }
        
        /* Overlay na imagem */
        .card-img-box::after {
            content: 'üîé';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30, 41, 59, 0.4);
            color: white;
            font-size: 1.2rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .card-img-box:hover::after { opacity: 1; }

        .card-meta { flex: 1; min-width: 0; }
        
        .card-line { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; flex-wrap: wrap; }
        .card-tag { 
            font-size: 0.7rem; 
            font-weight: 700;
            color: white; 
            background: var(--secondary); 
            padding: 2px 8px; 
            border-radius: 4px;
            text-transform: uppercase;
        }
        .card-sku-inline { font-weight: 700; font-size: 0.9rem; color: var(--text-main); }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Tabelas de Pre√ßo */
        .price-table th { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            color: var(--text-muted); 
            font-weight: 700; 
            letter-spacing: 0.5px; 
        }
        .price-table td { font-size: 0.85rem; }
        .price-min { color: #14499e; font-weight: 600; }
        .price-max { color: #dc2626; font-weight: 600; }
        .badge-desc { font-weight: 700; font-size: 0.75rem; }

        /* --- Modais --- */
        .image-modal, .prices-modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .image-modal.active, .prices-modal.active { display: flex; }

        .modal-backdrop, .prices-backdrop {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(2px);
            opacity: 0;
            animation: fadeIn 0.2s forwards;
        }

        .modal-content, .prices-content {
            position: relative;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            padding: 20px;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            gap: 16px;
            z-index: 1001;
            opacity: 0;
            transform: scale(0.95);
            animation: scaleIn 0.2s forwards;
        }
        
        .prices-content { width: 800px; }

        .modal-header, .prices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title, .prices-title { font-weight: 700; font-size: 1.1rem; color: var(--text-main); }
        .modal-close, .prices-close {
            border: none;
            background: transparent;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .modal-close:hover, .prices-close:hover { color: var(--danger); }

        .modal-image-box {
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 300px;
        }
        .modal-image-box img { max-width: 100%; max-height: 70vh; object-fit: contain; }

        .modal-actions { display: flex; justify-content: flex-end; }
        .btn-download {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-download:hover { background: var(--primary-hover); }

        @keyframes fadeIn { to { opacity: 1; } }
        @keyframes scaleIn { to { opacity: 1; transform: scale(1); } }

    </style>
</head>
<body class="organizador-page">


    <main class="main-container">

        <div class="card">
            <h1 class="page-title">Configura√ß√£o</h1>
            
            <form class="form-group">
                <div class="form-field">
                    <label for="excel_file" class="form-label">1. Arquivo Excel (.xlsx)</label>
                    <input type="file" id="excel_file" accept=".xlsx, .xls" class="file-input">
                    <small class="form-hint">Contendo estrutura de pastas e SKUs</small>
                </div>

                <div class="form-field">
                    <label for="sku_column" class="form-label">Nome da Coluna do SKU</label>
                    <input type="text" id="sku_column" placeholder="Padr√£o: Coluna E" class="input-field" value="CHAMADA">
                </div>

                <div class="form-field">
                    <label for="sales_column" class="form-label">Coluna de Vendas (Opcional)</label>
                    <input type="text" id="sales_column" placeholder="Ex: Vendas, Quantidade (Padr√£o: H)" class="input-field" value="NRO PEDIDOS">
                </div>

                <div class="form-field">
                    <label for="final_price_column" class="form-label">Coluna Pre√ßo Final</label>
                    <input type="text" id="final_price_column" placeholder="Ex: Pre√ßo Promo (Padr√£o: G)" class="input-field" value="PRECO_VAREJO">
                </div>

                <div id="status" class="status-message" role="alert" style="display: none;"></div>

                <div class="btn-group">
                    <button type="button" id="process_button" class="btn btn-primary">
                        üîç Processar & Gerar Preview
                    </button>
                    <button type="button" id="download_zip_button" class="btn btn-secondary" disabled>
                        üì¶ Baixar Estrutura (.zip)
                    </button>
                </div>
            </form>
        </div>

        <div class="card" id="preview_section" style="display:none; min-height: 500px;">
    
            <div class="preview-header">
                <div class="header-left">
                    <h3>Preview dos Produtos</h3>
                    <small id="preview_info" class="count-badge">...</small>
                </div>

                <div class="header-actions">
                    <label class="toggle-control" title="Filtrar apenas produtos Social Media">
                        <input type="checkbox" id="filter_social_media" />
                        <div class="toggle-track">
                            <div class="toggle-indicator"></div>
                        </div>
                        <span class="toggle-text">Social Media</span>
                    </label>

                    <div class="header-divider"></div>

                    <div class="sort-control">
                        <label for="sort_selector">Ordenar:</label>
                        <select id="sort_selector" class="select-clean">
                            <option value="alpha">Alfab√©tica</option>
                            <option value="ordem" selected>Ordem</option>
                        </select>
                    </div>
                    
                    </div>
            </div>
            
            <div id="tabs_container" class="tabs-container"></div>
            <div id="preview_container" class="preview-grid"></div>
        </div>

        <!-- Modal de Imagem -->
        <div id="image_modal" class="image-modal" aria-hidden="true">
            <div class="modal-backdrop"></div>
            <div class="modal-content" role="dialog" aria-modal="true">
                <div class="modal-header">
                    <div class="modal-title" id="modal_title">Imagem do produto</div>
                    <button id="modal_close" class="modal-close" aria-label="Fechar">‚úï</button>
                </div>
                <div class="modal-image-box">
                    <img id="modal_image" alt="Imagem do produto">
                </div>
                <div class="modal-actions">
                    <button id="modal_download" class="btn-download">‚¨áÔ∏è Baixar imagem</button>
                </div>
            </div>
        </div>

        <!-- Modal de Pre√ßos -->
        <div id="prices_modal" class="prices-modal" aria-hidden="true">
            <div class="prices-backdrop"></div>
            <div class="prices-content" role="dialog" aria-modal="true">
                <div class="prices-header">
                    <div class="prices-title" id="prices_title">Pre√ßos do produto</div>
                    <button id="prices_close" class="prices-close" aria-label="Fechar">‚úï</button>
                </div>
                <div id="prices_body"></div>
            </div>
        </div>
        
    </main>

    <script>
        // Pega os elementos do DOM
        const fileInput = document.getElementById('excel_file');
        const skuColumnInput = document.getElementById('sku_column');
        const salesColumnInput = document.getElementById('sales_column');
        const processButton = document.getElementById('process_button');
        const downloadZipButton = document.getElementById('download_zip_button');
        const statusDiv = document.getElementById('status');
        const finalPriceColumnInput = document.getElementById('final_price_column');
        const previewSection = document.getElementById('preview_section');
        const previewContainer = document.getElementById('preview_container');
        const previewInfo = document.getElementById('preview_info');

        // Armazena blobs de imagens j√° baixados para reutilizar
        const imagemBlobsPorSKU = new Map();
        const produtoInfoCache = new Map();
        const produtoPreviewData = [];
        let filtroBusca = '';

        // Adiciona o listener ao bot√£o
        processButton.addEventListener('click', handleProcessing);

        async function handleProcessing() {
            const excelFile = fileInput.files[0];
            const skuColumn = skuColumnInput.value.trim();
            const salesColumn = salesColumnInput.value.trim();
            const finalPriceColumn = finalPriceColumnInput.value.trim();

            if (!excelFile) {
                showStatus('Selecione um arquivo Excel (.xlsx).', true);
                return;
            }

            setLoading(true, 'Lendo arquivo...');

            try {
                // --- Fun√ß√µes Auxiliares (Mesma l√≥gica original) ---
                function _norm(s) {
                    s = String(s || '').trim().toLowerCase();
                    return s.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
                }

                function safe(name) {
                    name = String(name || '').trim();
                    if (!name) return '';
                    name = name.normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
                    name = name.replace(/\//g, '-');
                    name = name.replace(/[^A-Za-z0-9\-\._ ]/g, '');
                    name = name.replace(/\s+/g, ' ').trim();
                    return name.substring(0, 120);
                }

                function parseVendas(valor) {
                    if (typeof valor === 'number') return valor;
                    if (!valor) return 0;
                    let numStr = String(valor).replace(/[^\d,.-]/g, '');
                    numStr = numStr.replace(',', '.');
                    const num = parseFloat(numStr);
                    return isNaN(num) ? 0 : num;
                }

                async function buscarImagemPreviewCSV(sku) {
                    try {
                        const resp = await fetch('/api/buscar-imagem-por-sku', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sku })
                        });
                        if (!resp.ok) return null;
                        const data = await resp.json();
                        if (data && data.success && data.imagem) return String(data.imagem).trim();
                        return null;
                    } catch (e) {
                        console.warn('Erro buscar imagem CSV por SKU', sku, e);
                        return null;
                    }
                }

                async function buscarNomePorSKU(sku) {
                    try {
                        const resp = await fetch('/api/nome-produto-por-sku', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sku })
                        });
                        if (!resp.ok) return null;
                        const data = await resp.json();
                        if (data && data.success) return String(data.nome || '').trim();
                        return null;
                    } catch (e) {
                        console.warn('Erro buscar nome por SKU', sku, e);
                        return null;
                    }
                }

                function getExtensaoDoBlob(blob) {
                    const mimeToExt = {
                        'image/jpeg': 'jpg', 'image/jpg': 'jpg', 'image/png': 'png',
                        'image/gif': 'gif', 'image/webp': 'webp', 'image/bmp': 'bmp'
                    };
                    return mimeToExt[blob.type] || 'jpg';
                }

                const data = await excelFile.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                if (rows.length < 2) throw new Error('Planilha vazia ou sem cabe√ßalho.');

                setLoading(true, 'Processando colunas...');
                
                const headers = rows[0].map(h => String(h || '').trim());
                
                // Configura√ß√£o Fixa
                const COLS = {
                    sku: 'E', finalPrice: 'G', pedidos: 'H', creative: 'J', socialFlag: 'K', orderNum: 'L', dinamica: 'M',
                    precoBaseRange: ['AK','AL','AM','AN','AO','AP','AQ','AR','AS'],
                    lojaLabels: ['5','9','23','44','47','75','76','80','81'],
                    useFixedLetters: true
                };

                function colLetterToIndex(letter) {
                    letter = String(letter).toUpperCase().trim();
                    let sum = 0;
                    for (let i = 0; i < letter.length; i++) {
                        sum = sum * 26 + (letter.charCodeAt(i) - 64);
                    }
                    return sum - 1;
                }

                let idxSku = -1, idxFinalPrice = -1, idxSales = -1, idxCreative = -1, idxSocialFlag = -1, idxOrderNum = -1, idxDinamica = -1;
                let colFinalPriceName = null, priceBaseColumns = [];

                if (COLS.useFixedLetters) {
                    idxSku = colLetterToIndex(COLS.sku);
                    idxFinalPrice = colLetterToIndex(COLS.finalPrice);
                    idxSales = colLetterToIndex(COLS.pedidos);
                    idxCreative = colLetterToIndex(COLS.creative);
                    idxDinamica = colLetterToIndex(COLS.dinamica);
                    idxSocialFlag = colLetterToIndex(COLS.socialFlag);
                    idxOrderNum = colLetterToIndex(COLS.orderNum);
                    colFinalPriceName = headers[idxFinalPrice] || COLS.finalPrice;
                    priceBaseColumns = COLS.precoBaseRange.map((l, idx) => {
                        const i = colLetterToIndex(l);
                        const label = COLS.lojaLabels[idx] || l;
                        return { name: label, idx: i };
                    }).filter(c => c.idx < headers.length);
                }

                function parsePreco(valor) {
                    if (typeof valor === 'number') return valor;
                    if (!valor) return 0;
                    let s = String(valor).trim().replace(/\s+/g, '').replace(/R\$|r\$/g, '').replace(/\./g, '');
                    s = (s.match(/,/g) || []).length === 1 && !s.includes('.') ? s.replace(',', '.') : s.replace(/,/g, '.');
                    s = s.replace(/[^0-9.\-]/g, '');
                    const num = parseFloat(s);
                    return isNaN(num) ? 0 : num;
                }

                setLoading(true, 'Agrupando produtos...');
                
                const produtosPorPasta = new Map();
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row || row.length === 0) continue;

                    const creativeVal = safe(row[idxCreative]);
                    if (!creativeVal) continue;
                    const dinamicaVal = (idxDinamica !== -1 ? safe(row[idxDinamica]) : '').toUpperCase();
                    const socialFlagVal = (idxSocialFlag !== -1 ? String(row[idxSocialFlag] || '').trim() : '');
                    const orderNumValRaw = (idxOrderNum !== -1 ? row[idxOrderNum] : null);
                    const orderNumVal = (() => {
                        if (typeof orderNumValRaw === 'number') return orderNumValRaw;
                        if (!orderNumValRaw) return null;
                        const n = parseInt(String(orderNumValRaw).replace(/[^0-9\-]/g, ''), 10);
                        return isNaN(n) ? null : n;
                    })();
                    
                    // Sufixo num√©rico por proximidade da din√¢mica (Vertical/Mini/Panoramica)
                    function dinamicaPrefix(d) {
                        const n = String(d || '').toLowerCase().normalize('NFKD').replace(/[\u0300-\u036f]/g, '');
                        const isVertical = n.includes('vertical') || n.includes('vertic');
                        const isMini = n.includes('mini') || n.includes('mni');
                        const isPanor = n.includes('panor') || n.includes('panorama') || n.includes('panoramic');
                        if (isVertical) return '01 - ';
                        if (isMini) return '02 - ';
                        if (isPanor) return '03 - ';
                        return '';
                    }
                    const dinamicaWithPrefix = dinamicaVal ? (dinamicaPrefix(dinamicaVal) + dinamicaVal) : '';
                    const ordemPrefix = (orderNumVal !== null && orderNumVal !== undefined) ? String(orderNumVal).padStart(2, '0') + ' - ' : '';
                    let pastaKey = (dinamicaWithPrefix ? dinamicaWithPrefix + '/' : '') + ordemPrefix + creativeVal + '/';
                    const sku = (idxSku !== -1 && row[idxSku]) ? String(row[idxSku]).trim() : null;
                    const vendas = (idxSales !== -1 && row[idxSales] !== undefined) ? parseVendas(row[idxSales]) : 0;

                    if (!sku) continue;

                    if (!produtosPorPasta.has(pastaKey)) produtosPorPasta.set(pastaKey, []);
                    produtosPorPasta.get(pastaKey).push({ sku, vendas, pastaKey, rowIndex: i, socialFlag: socialFlagVal, orderNum: orderNumVal, dinamicaRaw: dinamicaVal });
                }

                const produtosSelecionados = [];
                const MAX_POR_PASTA = 5;

                for (const [pastaKey, produtos] of produtosPorPasta.entries()) {
                    let produtosOrdenados = produtos;
                    if (idxSales !== -1) produtosOrdenados = produtos.sort((a, b) => b.vendas - a.vendas);
                    produtosSelecionados.push(...produtosOrdenados.slice(0, MAX_POR_PASTA));
                }

                setLoading(true, 'Montando dados...');

                produtoPreviewData.length = 0;
                // Prepara em paralelo: pre√ßos + nome
                const buildPromises = produtosSelecionados.map(async (p) => {
                    const row = rows[p.rowIndex];
                    const precoFinal = (idxFinalPrice !== -1) ? parsePreco(row[idxFinalPrice]) : 0;
                    const lojas = priceBaseColumns.map(col => {
                        const val = parsePreco(row[col.idx]);
                        const desconto = precoFinal > 0 && val > 0 ? ((val - precoFinal) / val) * 100 : 0;
                        const descontoRounded = Math.floor(desconto);
                        return { loja: col.name, precoBase: val, precoFinal: precoFinal, desconto: desconto, descontoRounded };
                    });
                    const nomeProduto = await buscarNomePorSKU(p.sku);
                    produtoPreviewData.push({
                        sku: p.sku,
                        nome: nomeProduto || '',
                        pastaKey: p.pastaKey,
                        vendas: p.vendas,
                        dinamica: p.pastaKey.split('/')[0] || '',
                        dinamicaRaw: p.dinamicaRaw || '',
                        creative: p.pastaKey.split('/').slice(-2, -1)[0] || p.pastaKey,
                        socialMedia: (String(p.socialFlag || '').toUpperCase() === 'X'),
                        ordemBanner: p.orderNum,
                        precoFinal,
                        lojas,
                        imageURL: null,
                        imageBlob: null
                    });
                });
                await Promise.all(buildPromises);

                // Imagens: agora somente preview via CSV (sem scraping)
                setLoading(true, 'Carregando imagens de preview...');
                const BATCH_SIZE_PREVIEW = 8;
                for (let i = 0; i < produtoPreviewData.length; i += BATCH_SIZE_PREVIEW) {
                    const batch = produtoPreviewData.slice(i, i + BATCH_SIZE_PREVIEW);
                    await Promise.all(batch.map(async (prod) => {
                        const imgUrl = await buscarImagemPreviewCSV(prod.sku);
                        prod.imageURL = imgUrl || null; // exibe direto a URL; sem blob
                        prod.imageBlob = null;
                    }));
                }

                // Pr√©-carrega e salva em cache as informa√ß√µes detalhadas dos produtos (SKU, nome, ean, imagem, url)
                setLoading(true, 'Carregando informa√ß√µes dos produtos...');
                const BATCH_SIZE_INFO = 10;
                for (let i = 0; i < produtoPreviewData.length; i += BATCH_SIZE_INFO) {
                    const batch = produtoPreviewData.slice(i, i + BATCH_SIZE_INFO);
                    await Promise.all(batch.map(async (prod) => {
                        // Se j√° est√° em cache, pula
                        if (produtoInfoCache.has(prod.sku)) return;
                        try {
                            const resp = await fetch('/buscar-produto', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ termo: prod.sku })
                            });
                            if (resp.ok) {
                                const data = await resp.json();
                                const produtoInfo = (data && data.success) ? data.produto : null;
                                const cached = {
                                    sku: produtoInfo?.sku || prod.sku,
                                    nome: produtoInfo?.nome || prod.nome || '',
                                    ean: produtoInfo?.ean || '-',
                                    imagem: produtoInfo?.imagem || prod.imageURL || null,
                                    url: produtoInfo?.url || '-'
                                };
                                produtoInfoCache.set(prod.sku, cached);
                                // Atualiza nome no preview se vier do servidor
                                if (cached.nome && !prod.nome) prod.nome = cached.nome;
                                // Atualiza imagem se vier melhor
                                if (cached.imagem && !prod.imageURL) prod.imageURL = cached.imagem;
                            } else {
                                // Falha no servidor: ainda guarda um m√≠nimo no cache
                                produtoInfoCache.set(prod.sku, {
                                    sku: prod.sku,
                                    nome: prod.nome || '',
                                    ean: '-',
                                    imagem: prod.imageURL || null,
                                    url: '-'
                                });
                            }
                        } catch (e) {
                            // Erro de rede: garante cache m√≠nimo
                            produtoInfoCache.set(prod.sku, {
                                sku: prod.sku,
                                nome: prod.nome || '',
                                ean: '-',
                                imagem: prod.imageURL || null,
                                url: '-'
                            });
                        }
                    }));
                }

                function formatCurrency(v) { return v ? 'R$ ' + v.toFixed(2).replace('.', ',') : '‚Äî'; }
                function formatPct(p) { return p ? Math.floor(p) + '%' : '‚Äî'; }

                const dinamicas = Array.from(new Set(produtoPreviewData.map(p => p.dinamica || '‚Äî')));
                const tabsContainer = document.getElementById('tabs_container');
                const imageModal = document.getElementById('image_modal');
                const modalImg = document.getElementById('modal_image');
                const modalTitle = document.getElementById('modal_title');
                const modalCloseBtn = document.getElementById('modal_close');
                const modalDownloadBtn = document.getElementById('modal_download');
                let modalCurrentSKU = null;
                const filterSocialMediaCheckbox = document.getElementById('filter_social_media');
                const sortSelector = document.getElementById('sort_selector');

                function renderCards(items) {
                    // Aplica filtro de busca (nome ou SKU)
                    const query = filtroBusca.trim().toLowerCase();
                    let filtered = query ? items.filter(p =>
                        (p.sku || '').toLowerCase().includes(query) || (p.nome || '').toLowerCase().includes(query)
                    ) : items;

                    // Filtro independente: Produtos Social Media (flag X na coluna K)
                    if (filterSocialMediaCheckbox && filterSocialMediaCheckbox.checked) {
                        filtered = filtered.filter(p => !!p.socialMedia);
                    }

                    // Ordena√ß√£o: alfab√©tica ou pela ordem (coluna L)
                    const sortMode = (sortSelector ? sortSelector.value : 'alpha');
                    filtered = [...filtered].sort((a, b) => {
                        if (sortMode === 'ordem') {
                            const ao = (typeof a.ordemBanner === 'number') ? a.ordemBanner : Number.MAX_SAFE_INTEGER;
                            const bo = (typeof b.ordemBanner === 'number') ? b.ordemBanner : Number.MAX_SAFE_INTEGER;
                            if (ao !== bo) return ao - bo;
                            // tie-breaker por nome depois por SKU
                            const an = (a.nome || '').toLowerCase();
                            const bn = (b.nome || '').toLowerCase();
                            if (an && bn && an !== bn) return an.localeCompare(bn);
                            return (a.sku || '').toLowerCase().localeCompare((b.sku || '').toLowerCase());
                        } else {
                            const an = (a.nome || '').toLowerCase();
                            const bn = (b.nome || '').toLowerCase();
                            if (an && bn && an !== bn) return an.localeCompare(bn);
                            return (a.sku || '').toLowerCase().localeCompare((b.sku || '').toLowerCase());
                        }
                    });
                    const cardsHTML = filtered.map(prod => {
                        // Limita a exibi√ß√£o de lojas no card para n√£o ficar gigante
                        const displayLojas = prod.lojas; 
                        const descontosValidos = displayLojas.filter(l => l.descontoRounded > 0).map(l => l.descontoRounded);
                        let minDesc = descontosValidos.length ? Math.min(...descontosValidos) : null;
                        let maxDesc = descontosValidos.length ? Math.max(...descontosValidos) : null;
                        if (minDesc !== null && maxDesc !== null && minDesc === maxDesc) {
                            // Todos iguais ap√≥s arredondamento: n√£o destacar min/max
                            minDesc = null;
                            maxDesc = null;
                        }
                        // Min/Max de pre√ßo base (ignorando zeros)
                        const basesValidas = displayLojas.map(l => l.precoBase).filter(v => typeof v === 'number' && v > 0);
                        const minBase = basesValidas.length ? Math.min(...basesValidas) : null;
                        const maxBase = basesValidas.length ? Math.max(...basesValidas) : null;
                        
                        return `
                        <div class="preview-card">
                            <div class="card-header-flex">
                                <div class="card-img-box" data-sku="${prod.sku}">
                                    ${prod.imageURL ? `<img src="${prod.imageURL}" alt="${prod.sku}">` : '<span style="font-size:24px; color:#cbd5e1;">üñºÔ∏è</span>'}
                                </div>
                                <div class="card-meta">
                                    <div class="card-line">
                                        <div class="card-tag">${prod.dinamicaRaw || prod.dinamica || 'Geral'}</div>
                                        <div class="card-sku-inline">${prod.sku}</div>
                                    </div>
                                    ${typeof prod.ordemBanner === 'number' ? `<div class="card-sub">Ordem: ${prod.ordemBanner}</div>` : ''}
                                    ${prod.socialMedia ? `<div class="card-sub" style="color:#2563eb; font-weight:600;">Social Media</div>` : ''}
                                    ${prod.nome ? `<div class="card-sub" title="${prod.nome}">${prod.nome}</div>` : ''}
                                    <div class="card-sub">Vendas: ${prod.vendas}</div>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                    previewContainer.innerHTML = cardsHTML || '<p style="grid-column:1/-1; text-align:center; padding:20px; color:#64748b;">Nenhum produto encontrado.</p>';

                    // Liga evento de clique nas imagens
                    previewContainer.querySelectorAll('.card-img-box').forEach(box => {
                        box.addEventListener('click', () => {
                            const sku = box.getAttribute('data-sku');
                            const prod = produtoPreviewData.find(p => p.sku === sku);
                            if (!prod || !prod.imageURL) return;
                            modalCurrentSKU = prod.sku;
                            modalImg.src = prod.imageURL;
                            modalImg.alt = prod.sku;
                            modalTitle.textContent = `Imagem do produto: ${prod.sku}`;
                            imageModal.classList.add('active');
                            imageModal.setAttribute('aria-hidden', 'false');
                        });
                    });

                    // Liga evento de clique no card para abrir modal de pre√ßos
                    const pricesModal = document.getElementById('prices_modal');
                    const pricesTitle = document.getElementById('prices_title');
                    const pricesBody = document.getElementById('prices_body');
                    previewContainer.querySelectorAll('.preview-card').forEach(card => {
                        card.addEventListener('click', (e) => {
                            // Evita conflito se clique foi na imagem (j√° abre modal de imagem)
                            if (e.target && e.target.closest('.card-img-box')) return;
                            const sku = card.querySelector('.card-img-box')?.getAttribute('data-sku');
                            const prod = produtoPreviewData.find(p => p.sku === sku);
                            if (!prod) return;

                            // Monta tabela de pre√ßos para o modal
                            // Monta tabela de pre√ßos para o modal
                            const displayLojas = prod.lojas || [];
                            const basesValidas = displayLojas.map(l => l.precoBase).filter(v => typeof v === 'number' && v > 0);
                            const minBase = basesValidas.length ? Math.min(...basesValidas) : null;
                            const maxBase = basesValidas.length ? Math.max(...basesValidas) : null;

                            // Gera as linhas da tabela (l√≥gica mantida)
                            const rowsHTML = displayLojas.map(l => `
                                <tr>
                                    <td style="padding: 8px;">Loja ${l.loja}</td>
                                    <td style="padding: 8px;">${(minBase !== null && l.precoBase === minBase) ? `<span class="price-min">${formatCurrency(l.precoBase)}</span>` : (maxBase !== null && l.precoBase === maxBase) ? `<span class="price-max">${formatCurrency(l.precoBase)}</span>` : `${formatCurrency(l.precoBase)}`}</td>
                                    <td style="padding: 8px;">${formatCurrency(l.precoFinal)}</td>
                                    <td style="text-align:right; padding: 8px;">${l.descontoRounded > 0 ? `<span class="badge-desc" style="background:#def7ec; color:#03543f; padding:2px 6px; border-radius:4px; font-size:0.85em;">-${formatPct(l.descontoRounded)}</span>` : '-'}</td>
                                </tr>
                            `).join('');

                            pricesTitle.textContent = `${prod.nome || prod.sku}`;

                            // --- LAYOUT NOVO (FLEXBOX) ---
                            pricesBody.innerHTML = `
                                <div style="display: flex; flex-wrap: wrap; gap: 20px; align-items: flex-start;">
                                    
                                    <div id="product_info_block" class="card" style="flex: 1; min-width: 300px; padding: 16px; border: 1px solid var(--border, #e2e8f0); border-radius: 8px; background: var(--bg-card, #fff);">
                                        <div style="display:flex; align-items:center; justify-content:center; height:100px;">
                                            <small style="color: var(--text-muted, #64748b);">Carregando informa√ß√µes do produto...</small>
                                        </div>
                                    </div>

                                    <div style="flex: 1; min-width: 300px;">
                                        <div style="border: 1px solid var(--border, #e2e8f0); border-radius: 8px; overflow: hidden;">
                                            <table class="price-table" style="width:100%; border-collapse: collapse; background: #fff;">
                                                <thead style="background: var(--bg-header, #f8fafc); border-bottom: 1px solid var(--border, #e2e8f0);">
                                                    <tr>
                                                        <th style="padding: 10px; text-align: left;">Loja</th>
                                                        <th style="padding: 10px; text-align: left;">Base</th>
                                                        <th style="padding: 10px; text-align: left;">Final</th>
                                                        <th style="padding: 10px; text-align: right;">Desc.</th>
                                                    </tr>
                                                </thead>
                                                <tbody>${rowsHTML}</tbody>
                                            </table>
                                        </div>
                                    </div>

                                </div>
                            `;

                            // Usa o cache pr√©-carregado para preencher a coluna da ESQUERDA
                            let info = produtoInfoCache.get(prod.sku);
                            if (!info) {
                                // fallback m√≠nimo mesmo sem cache
                                info = { sku: prod.sku, nome: prod.nome || '', ean: '-', imagem: prod.imageURL || null, url: '-' };
                            }

                            const skuTxt = info.sku || prod.sku;
                            const nomeTxt = info.nome || prod.nome || '';
                            const eanTxt = info.ean || '-';
                            const imgTxt = info.imagem || prod.imageURL || '-';
                            const urlTxt = info.url || '-';

                            const infoHtml = `
                                <div style="display:flex; gap:16px; align-items:flex-start;">
                                    <div style="width:100px; height:100px; border:1px solid #e2e8f0; border-radius:8px; overflow:hidden; background:#f8fafc; display:flex; align-items:center; justify-content:center; flex-shrink:0;">
                                        ${imgTxt && imgTxt !== '-' ? `<img src="${imgTxt}" alt="${skuTxt}" style="width:100%; height:100%; object-fit:contain;"/>` : '<span style="font-size:24px; color:#cbd5e1;">üñºÔ∏è</span>'}
                                    </div>
                                    <div style="flex:1; min-width:0; font-size: 0.9em;">
                                        <div style="margin-bottom:8px;">
                                            <span style="font-weight:700; color:var(--text-main, #334155);">SKU:</span> 
                                            <span style="color:var(--text-body, #475569);">${skuTxt}</span>
                                        </div>
                                        <div style="margin-bottom:8px;">
                                            <span style="font-weight:700; color:var(--text-main, #334155);">Nome:</span>
                                            <div style="color:var(--text-body, #475569); line-height:1.4;">${nomeTxt}</div>
                                        </div>
                                        <div style="margin-bottom:8px;">
                                            <span style="font-weight:700; color:var(--text-main, #334155);">EAN:</span>
                                            <span style="color:var(--text-body, #475569);">${eanTxt}</span>
                                        </div>
                                        
                                        <div style="margin-top:12px; display:flex; flex-direction:column; gap:5px;">
                                            ${urlTxt !== '-' ? `<a href="${urlTxt}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:none; font-size:0.85em;">üîó Acessar Link do Produto</a>` : ''}
                                            ${imgTxt && imgTxt !== '-' ? `<a href="${imgTxt}" target="_blank" rel="noopener" style="color:#2563eb; text-decoration:none; font-size:0.85em;">üñºÔ∏è Ver Imagem Original</a>` : ''}
                                        </div>

                                    </div>
                                </div>
                            `;

                            const block = document.getElementById('product_info_block');
                            if (block) block.innerHTML = infoHtml;
                            pricesModal.classList.add('active');
                            pricesModal.setAttribute('aria-hidden', 'false');
                        });
                    });
                }

                function renderTabs(activeDinamica) {
                    const allLabel = 'Todas';
                    const allTabs = [allLabel, ...dinamicas];
                    tabsContainer.innerHTML = allTabs.map(d => {
                        const isActive = d === activeDinamica ? 'active' : '';
                        return `<button class="tab-btn ${isActive}" data-d="${d}">${d}</button>`;
                    }).join('');
                    
                    tabsContainer.querySelectorAll('button').forEach(btn => {
                        btn.addEventListener('click', () => {
                            const d = btn.getAttribute('data-d');
                            renderTabs(d);
                            const items = d === allLabel ? produtoPreviewData : produtoPreviewData.filter(p => (p.dinamica || '‚Äî') === d);
                            renderCards(items);
                            previewInfo.textContent = `${items.length} produto(s) exibidos`;
                        });
                    });
                }

                previewSection.style.display = 'block';
                // Insere barra de busca
                const header = document.querySelector('.preview-header');
                let searchBox = document.getElementById('product_search_box');
                if (!searchBox) {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'product_search_box';
                    input.placeholder = 'Buscar por nome ou SKU...';
                    input.className = 'input-field';
                    input.style.maxWidth = '320px';
                    input.addEventListener('input', (e) => {
                        filtroBusca = e.target.value || '';
                        const activeTab = document.querySelector('.tab-btn.active');
                        const d = activeTab ? activeTab.getAttribute('data-d') : 'Todas';
                        const items = d === 'Todas' ? produtoPreviewData : produtoPreviewData.filter(p => (p.dinamica || '‚Äî') === d);
                        renderCards(items);
                        previewInfo.textContent = `${items.length} produto(s) exibidos`;
                    });
                    header.appendChild(input);
                }
                // Liga eventos dos filtros independentes
                if (filterSocialMediaCheckbox) {
                    filterSocialMediaCheckbox.addEventListener('change', () => {
                        const activeTab = document.querySelector('.tab-btn.active');
                        const d = activeTab ? activeTab.getAttribute('data-d') : 'Todas';
                        const items = d === 'Todas' ? produtoPreviewData : produtoPreviewData.filter(p => (p.dinamica || '‚Äî') === d);
                        renderCards(items);
                        previewInfo.textContent = `${items.length} produto(s) exibidos`;
                    });
                }
                if (sortSelector) {
                    sortSelector.addEventListener('change', () => {
                        const activeTab = document.querySelector('.tab-btn.active');
                        const d = activeTab ? activeTab.getAttribute('data-d') : 'Todas';
                        const items = d === 'Todas' ? produtoPreviewData : produtoPreviewData.filter(p => (p.dinamica || '‚Äî') === d);
                        renderCards(items);
                        previewInfo.textContent = `${items.length} produto(s) exibidos`;
                    });
                }
                renderTabs('Todas');
                renderCards(produtoPreviewData);
                previewInfo.textContent = `Total: ${produtoPreviewData.length} produto(s)`;
                downloadZipButton.disabled = produtoPreviewData.length === 0;

                setLoading(false);
                showStatus('Preview gerada com sucesso!', false);
                processButton.textContent = 'üîÑ Reprocessar';

            } catch (error) {
                console.error(error);
                showStatus(`Erro: ${error.message}`, true);
                setLoading(false);
            }
        }

        // Eventos do modal
        (function setupModalEvents(){
            const imageModal = document.getElementById('image_modal');
            const modalCloseBtn = document.getElementById('modal_close');
            const modalBackdrop = imageModal.querySelector('.modal-backdrop');
            const modalDownloadBtn = document.getElementById('modal_download');
            const modalImg = document.getElementById('modal_image');
            let currentSKUForDownload = null;

            // Atualiza SKU corrente ao abrir
            document.addEventListener('click', (e) => {
                if (e.target && e.target.closest('.card-img-box')) {
                    const box = e.target.closest('.card-img-box');
                    currentSKUForDownload = box.getAttribute('data-sku');
                }
            });

            function closeModal(){
                imageModal.classList.remove('active');
                imageModal.setAttribute('aria-hidden', 'true');
                modalImg.src = '';
            }

            modalCloseBtn.addEventListener('click', closeModal);
            modalBackdrop.addEventListener('click', closeModal);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });

            modalDownloadBtn.addEventListener('click', async () => {
                if (!currentSKUForDownload) return;
                const prod = produtoPreviewData.find(p => p.sku === currentSKUForDownload);
                if (!prod) return;
                try {
                    let blob = null;
                    // Tenta via proxy da URL do CSV primeiro
                    // Tenta usar imagem do cache se dispon√≠vel
                    const cached = produtoInfoCache.get(prod.sku);
                    const cachedImage = cached?.imagem || null;
                    const candidateUrl = cachedImage || prod.imageURL;
                    if (candidateUrl) {
                        const resp = await fetch('/api/proxy-imagem', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: candidateUrl })
                        });
                        if (resp.ok) {
                            blob = await resp.blob();
                        }
                    }
                    // Fallback: webscraping da p√°gina do produto
                    if (!blob) {
                        const resp2 = await fetch('/api/buscar-e-baixar-imagem-produto', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ sku: prod.sku })
                        });
                        if (resp2.ok) {
                            blob = await resp2.blob();
                        }
                    }
                    if (!blob) return;
                    const extensao = getExtensaoDoBlob(blob);
                    const nomeArquivo = `${prod.sku.replace(/[^A-Za-z0-9_\-\.]/g,'')}.${extensao}`;
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = nomeArquivo;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    console.warn('Erro ao baixar imagem do modal', e);
                }
            });
        })();

        // Eventos do modal de pre√ßos
        (function setupPricesModal(){
            const pricesModal = document.getElementById('prices_modal');
            const pricesCloseBtn = document.getElementById('prices_close');
            const pricesBackdrop = document.querySelector('#prices_modal .prices-backdrop');

            function closeModal(){
                pricesModal.classList.remove('active');
                pricesModal.setAttribute('aria-hidden', 'true');
            }

            pricesCloseBtn.addEventListener('click', closeModal);
            pricesBackdrop.addEventListener('click', closeModal);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModal(); });
        })();

        function setLoading(isLoading, message = '') {
            processButton.disabled = isLoading;
            if (isLoading) {
                processButton.textContent = message || 'Processando...';
                statusDiv.textContent = message;
                statusDiv.className = 'status-message status-info';
                statusDiv.style.display = 'block';
            } else {
                processButton.textContent = 'üîç Processar & Gerar Preview';
            }
        }

        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'status-message status-error' : 'status-message status-success';
            statusDiv.style.display = 'block';
        }

        // Fun√ß√£o utilit√°ria usada na gera√ß√£o do ZIP (escopo global deste script)
        function getExtensaoDoBlob(blob) {
            const mimeToExt = {
                'image/jpeg': 'jpg', 'image/jpg': 'jpg', 'image/png': 'png',
                'image/gif': 'gif', 'image/webp': 'webp', 'image/bmp': 'bmp'
            };
            return mimeToExt[blob.type] || 'jpg';
        }

        downloadZipButton.addEventListener('click', async () => {
            if (downloadZipButton.disabled) return;
            setLoading(true, 'Baixando imagens e gerando ZIP...');
            try {
                const excelFile = fileInput.files[0];
                const origName = excelFile ? excelFile.name.split('.')[0] : 'pastas';
                const zipFileName = `${origName}_organizado.zip`;
                
                const zip = new JSZip();
                const createdPaths = new Set();
                
                for (const prod of produtoPreviewData) {
                    if (!createdPaths.has(prod.pastaKey)) {
                        zip.file(prod.pastaKey + '.keep', '');
                        createdPaths.add(prod.pastaKey);
                    }
                    // Na etapa de download: buscar blob (proxy CSV ‚Üí fallback scraping)
                    let blob = null;
                    try {
                        if (prod.imageURL) {
                            const resp = await fetch('/api/proxy-imagem', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: prod.imageURL })
                            });
                            if (resp.ok) blob = await resp.blob();
                        }
                        if (!blob) {
                            const resp2 = await fetch('/api/buscar-e-baixar-imagem-produto', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ sku: prod.sku })
                            });
                            if (resp2.ok) blob = await resp2.blob();
                        }
                    } catch (e) {
                        console.warn('Erro baixando imagem para ZIP', prod.sku, e);
                    }
                    if (blob) {
                        const extensao = getExtensaoDoBlob(blob);
                        const nomeArquivo = `${prod.sku.replace(/[^A-Za-z0-9_\-\.]/g,'')}.${extensao}`;
                        zip.file(prod.pastaKey + nomeArquivo, blob);
                    }
                }
                const content = await zip.generateAsync({ type: 'blob' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = zipFileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                showStatus(`ZIP gerado com sucesso: ${zipFileName}`, false);
            } catch (e) {
                showStatus(`Erro ao gerar ZIP: ${e.message}`, true);
            } finally {
                setLoading(false);
            }
        });
    </script>
</body>
</html>