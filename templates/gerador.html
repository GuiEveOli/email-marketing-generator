<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Email Marketing</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body class="gerador-page">
    {% set current = request.path %}
    <header class="top-nav">
        <div class="nav-inner">
            <a href="/" class="brand">üõ†Ô∏è Ferramentas</a>
            <nav class="nav-links">
                <a href="/" class="{% if current == '/' %}active{% endif %}">Hub</a>
                <a href="/gerador" class="{% if current.startswith('/gerador') %}active{% endif %}">Gerador</a>
                <a href="/skuconsult" class="{% if current.startswith('/skuconsult') %}active{% endif %}">SKU Consult</a>
                <a href="/organizador" class="{% if current.startswith('/organizador') %}active{% endif %}">Organizador</a>

            </nav>
        </div>
    </header>

    <!-- Loading overlay -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Gerando email marketing...</p>
    </div>

    <!-- Container de toasts -->
    <div class="toast-container" id="toastContainer"></div>

    <div class="container container-three-cols">
        <h1>Gerador de Email Marketing</h1>
        <p class="subtitle">Adicione produtos por URL, SKU ou EAN</p>

        <form id="formGerador">
            <!-- Se√ß√£o de Busca e Produtos (ESQUERDA) -->
            <div class="search-section">
                <h2>1. Buscar e Adicionar Produtos</h2>
                <div class="search-box">
                    <input 
                        type="text" 
                        id="termoBusca" 
                        placeholder="Digite o SKU, EAN ou nome do produto..."
                        autocomplete="off"
                    >
                    <div class="sugestoes-dropdown" id="sugestoesDropdown">
                        <!-- Sugest√µes aparecer√£o aqui -->
                    </div>
                    <button type="button" class="btn-adicionar" onclick="adicionarProdutoPorUrl()">
                        + Adicionar
                    </button>
                </div>
                
                <div class="contador-produtos" id="contadorProdutos">
                    Nenhum produto selecionado
                </div>

                <div class="produtos-selecionados" id="produtosSelecionados">
                    <!-- Cards dos produtos aparecer√£o aqui -->
                </div>
            </div>

            <!-- Se√ß√£o de Configura√ß√µes (CENTRO) -->
            <div class="config-section">
                <!-- Configura√ß√£o de UTM -->
                <div class="config-group">
                    <h2>2. Configura√ß√£o de UTM</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                        <label>Fonte da Campanha</label>
                        <input 
                            type="text" 
                            name="utm_source" 
                            id="utm_source" 
                            placeholder="ex: email-mkt, social media..."
                            value="email-mkt"
                        >
                        </div>

                        <div class="form-group">
                        <label>Nome da campanha</label>
                        <input 
                            type="text" 
                            name="utm_campaign" 
                            id="utm_campaign" 
                            placeholder="ex: promo-verao, super barato..."
                            value=""
                        >
                         </div>

                        <div class="form-group" style="grid-column: span 2;">
                            <label>URL do CTA "Ver todas as ofertas"</label>
                            <input 
                                type="url" 
                                name="cta_url" 
                                id="cta_url" 
                                placeholder="https://www.superkoch.com.br/promocoes"
                                value="https://www.superkoch.com.br/promocoes"
                            >
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">URL do bot√£o principal. Os UTMs ser√£o adicionados automaticamente.</small>
                        </div> 
                    </div>
                    
                </div>

                <!-- Sele√ß√£o de Componentes -->
                <div class="config-group">
                    <h2>3. Sele√ß√£o de Componentes</h2>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group" style="grid-column: span 2;">
                            <label>Texto do Preheader</label>
                            <input 
                                type="text" 
                                name="preheader_text" 
                                id="preheader_text" 
                                placeholder="Pe√ßa at√© as 15h e receba HOJE. Sujeito a disponibilidade."
                                value="Pe√ßa at√© as 15h e receba HOJE. Sujeito a disponibilidade."
                            >
                            <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Texto que aparece no preview do email (oculto no corpo).</small>
                        </div>

                        <div class="form-group">
                            <label for="componente_bloco_03">
                                <span style="font-weight: 600;">Banners Pr√© Produtos</span>
                                <small style="display: block; color: #6b7280; font-weight: 400; margin-top: 2px;">Banners antes dos produtos</small>
                            </label>
                            <div class="custom-dropdown" data-dropdown="bloco_03">
                                <div class="custom-dropdown-selected">
                                    <span class="selected-text">Nenhum banner</span>
                                    <svg class="dropdown-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
                                        <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <div class="custom-dropdown-options">
                                    <div class="dropdown-option" data-value="">
                                        <span class="option-text">Nenhum banner</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_03_categorias_1x1">
                                        <span class="option-text">1x1</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_03_categorias_1x2">
                                        <span class="option-text">1x2</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_03_categorias_1x4">
                                        <span class="option-text">1x4</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_03_categorias_2x1">
                                        <span class="option-text">2x1</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_03_categorias_2x2">
                                        <span class="option-text">2x2</span>
                                    </div>
                                </div>
                                <input type="hidden" id="componente_bloco_03" name="componente_bloco_03" value="">
                            </div>
                            
                        </div>

                        <div class="form-group">
                            <label for="componente_bloco_05">
                                <span style="font-weight: 600;">Banners P√≥s Produtos</span>
                                <small style="display: block; color: #6b7280; font-weight: 400; margin-top: 2px;">Banners depois dos produtos</small>
                            </label>
                            <div class="custom-dropdown" data-dropdown="bloco_05">
                                <div class="custom-dropdown-selected">
                                    <span class="selected-text">Nenhum banner</span>
                                    <svg class="dropdown-arrow" width="12" height="8" viewBox="0 0 12 8" fill="none">
                                        <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                </div>
                                <div class="custom-dropdown-options">
                                    <div class="dropdown-option" data-value="">
                                        <span class="option-text">Nenhum banner</span>
                                    </div>
                                    <div class="dropdown-option" data-value="bloco_05_banner_full">
                                        <span class="option-text">1x1</span>
                                    </div>
                                </div>
                                <input type="hidden" id="componente_bloco_05" name="componente_bloco_05" value="">
                            </div>
                            
                        </div>
                        <div class="form-group">
                            <label for="toggle-cupom">Email Com Cupom?</label>
                            <div class="toggle-switch-wrapper">
                                <input type="checkbox" id="toggle-cupom" class="toggle-switch-input" onchange="toggleCupom()">
                                <label for="toggle-cupom" class="toggle-switch-label">
                                    <span class="toggle-switch-inner"></span>
                                    <span class="toggle-switch-switch"></span>
                                </label>
                            </div>
                            <input type="hidden" name="componente_bloco_cupom" id="componente_bloco_cupom" value="">
                        </div>
                        <div class="form-group">
                            <label for="toggle-apenas-produtos">Apenas produtos</label>
                            <div class="toggle-switch-wrapper">
                                <input type="checkbox" id="toggle-apenas-produtos" class="toggle-switch-input" onchange="toggleApenasProdutos()">
                                <label for="toggle-apenas-produtos" class="toggle-switch-label">
                                    <span class="toggle-switch-inner"></span>
                                    <span class="toggle-switch-switch"></span>
                                </label>
                            </div>
                            <input type="hidden" name="apenas_produtos" id="apenas_produtos" value="">
                        </div>
                    </div>
                </div>

                <!-- Personaliza√ß√£o -->
                <div class="config-group">
                    <h2>4. Personaliza√ß√£o</h2>
                    <div class="form-group">
                        <label for="cor_botao">Cor do Bot√£o "Ver Produto":</label>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="color" id="cor_botao_picker" value="#122447" style="width: 60px; height: 40px; cursor: pointer; border: 2px solid #e0e0e0; border-radius: 8px; padding: 4px 8px;">
                            <input type="text" id="cor_botao_hex" value="#122447" placeholder="#122447" maxlength="7" style="flex: 1; text-transform: uppercase;" pattern="^#[0-9A-Fa-f]{6}$">
                            <button type="button" id="btn_resetar_cor" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">Resetar</button>
                        </div>
                        <small style="color: #666; font-size: 12px; margin-top: 5px; display: block;">Escolha a cor do bot√£o usando o seletor ou digite o c√≥digo hexadecimal</small>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Preview (DIREITA) -->
            <div class="preview-section">
                <div class="preview-header">
                    <h2>Email Preview</h2>
                    <button type="button" class="btn-refresh-preview" onclick="atualizarPreview()" title="Atualizar preview">
                        üîÑ
                    </button>
                </div>
                <div class="preview-container" id="previewContainer">
                    <div class="preview-empty">
                        <p>Adicione produtos e configure os componentes para visualizar o preview</p>
                    </div>
                </div>
            </div>

            <!-- Bot√£o Gerar - Fixo no canto inferior direito -->
            <div class="bottom-actions">
                <button type="submit" class="btn-action btn-primary" id="btnGerar">
                    üöÄ Gerar Email
                </button>
            </div>
        </form>
    </div>

    <script>
        let produtosSelecionados = [];
        let timeoutBusca = null;
        let draggedElement = null;
        let draggedIndex = null;

        const corPicker = document.getElementById('cor_botao_picker');
        const corHex = document.getElementById('cor_botao_hex');
        const btnResetar = document.getElementById('btn_resetar_cor');

        corPicker.addEventListener('input', function() {
            corHex.value = this.value.toUpperCase();
            atualizarPreview();
        });

        corHex.addEventListener('input', function() {
            let valor = this.value.trim();
            
            if (valor && !valor.startsWith('#')) {
                valor = '#' + valor;
                this.value = valor;
            }
            
            if (/^#[0-9A-Fa-f]{6}$/.test(valor)) {
                corPicker.value = valor;
                this.style.borderColor = '#e0e0e0';
                atualizarPreview();
            } else if (valor.length === 7) {
                this.style.borderColor = '#dc3545';
            }
        });

        btnResetar.addEventListener('click', function() {
            corPicker.value = '#122447';
            corHex.value = '#122447';
            corHex.style.borderColor = '#e0e0e0';
            mostrarMensagem('Cor resetada para o padr√£o', 'sucesso');
            atualizarPreview();
        });

        function atualizarPreview() {
            const previewContainer = document.getElementById('previewContainer');
            const bloco03 = document.getElementById('componente_bloco_03').value;
            const bloco05 = document.getElementById('componente_bloco_05').value;
            const blocoCupom = document.getElementById('componente_bloco_cupom').value;
            const apenasProdutos = document.getElementById('apenas_produtos').value === 'true';
            const corBotao = document.getElementById('cor_botao_hex').value;

            let html = '<div class="email-preview">';

            // Se "apenas produtos" estiver ativo, pula header/footer/banners
            if (!apenasProdutos) {
                // Header fixo
                html += `
                    <div class="preview-block preview-header-block">
                        <div style="text-align: center;">
                            <img src="https://placehold.co/600x400/png" alt="Banner" style="width: 100%;">
                            <img src="{{ url_for('static', filename='img/receba-mesmo-dia.png') }}" alt="Receba no mesmo dia" style="width: 100%; padding: 8px">
                        </div>
                    </div>
                `;

                // Banner Pr√© Produtos
                if (bloco03) {
                    html += `<div class="preview-block preview-banner-pre">`;
                    if (bloco03 === 'bloco_03_categorias_1x1') {
                        html += `<img src="https://placehold.co/600x150/png" style="width: 100%; display: block;">`;
                    } else if (bloco03 === 'bloco_03_categorias_1x2') {
                        html += `
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block;">
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block; margin-top: 4px;">
                        `;
                    } else if (bloco03 === 'bloco_03_categorias_1x4') {
                        html += `
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block;">
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block; margin-top: 4px;">
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block; margin-top: 4px;">
                            <img src="https://placehold.co/600x150/png" style="width: 100%; display: block; margin-top: 4px;">
                        `;         
                    } else if (bloco03 === 'bloco_03_categorias_2x1') {
                        html += `
                            <div style="display: flex; gap: 4px; width: 100%;">
                                <img src="https://placehold.co/300x400/png" style="width: 48%; display: block;">
                                <img src="https://placehold.co/300x400/png" style="width: 48%; display: block;">
                            </div>
                        `;
                    } else if (bloco03 === 'bloco_03_categorias_2x2') {
                        html += `
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; width: 100%;">
                                <img src="https://placehold.co/300x300/png" style="width: 100%; display: block;">
                                <img src="https://placehold.co/300x300/png" style="width: 100%; display: block;">
                                <img src="https://placehold.co/300x300/png" style="width: 100%; display: block;">
                                <img src="https://placehold.co/300x300/png" style="width: 100%; display: block;">
                            </div>
                        `;
                    }
                    html += `</div>`;
                }
            }

            // Produtos (sempre mostrado)
            if (produtosSelecionados.length > 0) {
                html += `<div class="preview-block preview-produtos">`;
                html += `<div style="background: ${apenasProdutos ? 'white' : '#f5f5f5'}; padding: 0; text-align: center;">`;
                html += `</div>`;
                
                // Grid de 2 colunas
                html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; background: white; padding: 8px;">`;
                
                produtosSelecionados.forEach((produto, index) => {
                    const badgeClube = produto.is_clube ? '<span style="background: #034abb; color: white; padding: 2px 6px; font-size: 10px; border-radius: 3px; margin-right: 4px;">CLUBE</span>' : '';
                    const badgeExclusivo = produto.is_exclusivo ? '<span style="background: #122447; color: white; padding: 2px 6px; font-size: 10px; border-radius: 3px; margin-right: 4px;">SITE</span>' : '';
                    const badgeRelampago = produto.is_oferta_relampago ? '<span style="background: #ffd700; color: #000000; padding: 2px 6px; font-size: 10px; border-radius: 3px;">REL√ÇMPAGO</span>' : '';
                    
                    html += `
                        <div class="preview-produto" style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 10px; background: white;">
                            <div style="text-align: center; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: center; align-items: center; margin-bottom: 8px; min-height: 100px;">
                                    <img src="${produto.imagem}" alt="${produto.nome}" style="width: 100%; max-width: 100px; height: 100px; object-fit: contain;" onerror="this.src='https://via.placeholder.com/100?text=?'">
                                </div>
                            </div>
                            <div style="text-align: left;">
                                <div style="margin-bottom: 5px;">${badgeClube}${badgeExclusivo}${badgeRelampago}</div>
                                <div style="font-size: 11px; color: #333; line-height: 1.3; min-height: 40px; margin-bottom: 8px;">${produto.nome.substring(0, 50)}...</div>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`; // Fecha o grid
                html += `</div>`; // Fecha preview-produtos
            }

            // Continua apenas se N√ÉO for "apenas produtos"
            if (!apenasProdutos) {
                // Banner P√≥s Produtos
                if (bloco05) {
                    html += `<div class="preview-block preview-banner-pos">`;
                    if (bloco05 === 'bloco_05_banner_full') {
                        html += `<img src="https://placehold.co/600x150/png" style="width: 100%; display: block;">`;
                    }
                    html += `</div>`;
                }
                
                // Call to Action
                html += `
                    <div class="preview-block">
                        <div style="display: flex; justify-content: center; padding: 12px;">
                            <a target="_blank" style="font-size: 12px; color: #ffffff; background-color: #ff0000; text-decoration: none; border-radius: 52px; padding: 7px 13px; display: inline-block;" href="">Ver todas as ofertas
                            </a>
                        </div>
                    </div>
                `;

                // Banner Cupom Explicativo
                if (blocoCupom === 'bloco_cupom_explicativo') {
                    html += `
                        <div class="preview-block preview-banner-pos">
                            <img src="{{ url_for('static', filename='img/cupom_explicativo.png') }}" alt="Banner de Cupom" style="width: 100%; display: block;">
                        </div>
                    `;
                }

                // Footer fixo
                html += `
                    <div class="preview-block preview-footer-block">
                        <div style="background: #f5f5f5; padding: 20px; text-align: center; font-size: 11px; color: #666;">
                            <p style="margin: 0;">¬© 2025 - Todos os direitos reservados</p>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            previewContainer.innerHTML = html;
        }

        function mostrarMensagem(texto, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            let icone = '‚úì';
            if (tipo === 'erro') icone = '‚úï';
            if (tipo === 'info') icone = '‚Ñπ';
            
            toast.innerHTML = `
                <span class="toast-icon">${icone}</span>
                <span class="toast-message">${texto}</span>
                <button class="toast-close" onclick="fecharToast(this)">√ó</button>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('hide');
                setTimeout(() => toast.remove(), 300);
            }, 5000);
        }

        function fecharToast(button) {
            const toast = button.closest('.toast');
            toast.classList.add('hide');
            setTimeout(() => toast.remove(), 300);
        }

        function atualizarContador() {
            const contador = document.getElementById('contadorProdutos');
            if (contador) {
                contador.textContent = `${produtosSelecionados.length} produto(s) selecionado(s)`;
            }
        }

        function renderizarProdutos() {
            const container = document.getElementById('produtosSelecionados');
            container.innerHTML = '';

            produtosSelecionados.forEach((produto, index) => {
                const card = document.createElement('div');
                card.className = 'produto-card produto-item';
                card.draggable = true;
                card.dataset.index = index;
                
                card.innerHTML = `
                    <button type="button" class="btn-remover" onclick="removerProduto(${index})">√ó</button>
                    <div class="ordem-numero">${index + 1}</div>
                    <span class="drag-handle" title="Arrastar para reordenar">‚ãÆ‚ãÆ</span>
                    <img src="${produto.imagem}" alt="${produto.nome}" onerror="this.src='https://via.placeholder.com/150?text=Sem+Imagem'">
                    <h3>${produto.nome}</h3>
                    <div class="info"><strong>SKU:</strong> ${produto.sku}</div>
                    <div class="info"><strong>EAN:</strong> ${produto.ean || '-'}</div>
                    
                    <div style="display: flex; flex-direction: column; gap: 6px; margin-top: 10px;">
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" class="checkbox-clube" data-index="${index}" style="cursor: pointer; width: 16px; height: 16px;" onchange="sincronizarCheckbox(${index}, 'clube'); atualizarPreview();">
                            <span style="color: #034abb; font-weight: 600;">Produto Clube</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" class="checkbox-exclusivo" data-index="${index}" style="cursor: pointer; width: 16px; height: 16px;" onchange="sincronizarCheckbox(${index}, 'exclusivo'); atualizarPreview();">
                            <span style="color: #122447; font-weight: 600;">Exclusivo Site</span>
                        </label>
                        
                        <label style="display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 12px;">
                            <input type="checkbox" class="checkbox-relampago" data-index="${index}" style="cursor: pointer; width: 16px; height: 16px;" onchange="sincronizarCheckbox(${index}, 'relampago'); atualizarPreview();">
                            <span style="color: #ffcd00; font-weight: 600;">Oferta Rel√¢mpago</span>
                        </label>
                    </div>
                `;
                
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragend', handleDragEnd);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragleave', handleDragLeave);
                
                container.appendChild(card);
            });

            atualizarContador();
            atualizarPreview();
        }

        function sincronizarCheckbox(index, tipo) {
            const checkbox = tipo === 'clube' 
                ? document.querySelector(`.checkbox-clube[data-index="${index}"]`)
                : tipo === 'exclusivo'
                ? document.querySelector(`.checkbox-exclusivo[data-index="${index}"]`)
                : document.querySelector(`.checkbox-relampago[data-index="${index}"]`);
            
            if (checkbox && produtosSelecionados[index]) {
                if (tipo === 'clube') {
                    produtosSelecionados[index].is_clube = checkbox.checked;
                } else if (tipo === 'exclusivo') {
                    produtosSelecionados[index].is_exclusivo = checkbox.checked;
                } else if (tipo === 'relampago') {
                    produtosSelecionados[index].is_oferta_relampago = checkbox.checked;
                }
            }
        }

        function handleDragStart(e) {
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }
        
        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.produto-item').forEach(item => {
                item.classList.remove('drag-over');
            });
        }
        
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const targetIndex = parseInt(this.dataset.index);
            if (targetIndex !== draggedIndex) {
                this.classList.add('drag-over');
            }
            
            return false;
        }
        
        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const targetIndex = parseInt(this.dataset.index);
            
            if (draggedIndex !== targetIndex) {
                const item = produtosSelecionados.splice(draggedIndex, 1)[0];
                produtosSelecionados.splice(targetIndex, 0, item);
                renderizarProdutos();
                mostrarMensagem(`‚úì Produto movido: posi√ß√£o ${draggedIndex + 1} ‚Üí ${targetIndex + 1}`, 'sucesso');
            }
            
            return false;
        }

        async function buscarSugestoes(termo) {
            if (!termo) {
                esconderSugestoes();
                return;
            }

            const isNumerico = /^\d+$/.test(termo);
            const minCaracteres = isNumerico ? 1 : 2;

            if (termo.length < minCaracteres) {
                esconderSugestoes();
                return;
            }

            try {
                const response = await fetch('/buscar-sugestoes', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ termo })
                });

                const data = await response.json();

                if (data.success && data.sugestoes.length > 0) {
                    mostrarSugestoes(data.sugestoes);
                } else {
                    mostrarSemResultados();
                }
            } catch (error) {
                console.error('Erro ao buscar sugest√µes:', error);
                mostrarMensagem('Erro ao buscar produtos', 'erro');
                esconderSugestoes();
            }
        }

        function mostrarSugestoes(sugestoes) {
            const dropdown = document.getElementById('sugestoesDropdown');
            dropdown.innerHTML = '';

            sugestoes.forEach(produto => {
                const item = document.createElement('div');
                item.className = 'sugestao-item';
                item.innerHTML = `
                    <img src="${produto.imagem}" alt="${produto.nome}" onerror="this.src='https://via.placeholder.com/50?text=?'">
                    <div class="sugestao-info">
                        <div class="sugestao-nome">${produto.nome}</div>
                        <div class="sugestao-detalhes">SKU: ${produto.sku} | EAN: ${produto.ean}</div>
                    </div>
                `;
                item.onclick = () => selecionarProduto(produto);
                dropdown.appendChild(item);
            });

            dropdown.classList.add('show');
        }

        function mostrarSemResultados() {
            const dropdown = document.getElementById('sugestoesDropdown');
            dropdown.innerHTML = '<div class="sem-resultados">Nenhum produto encontrado</div>';
            dropdown.classList.add('show');
        }

        function esconderSugestoes() {
            const dropdown = document.getElementById('sugestoesDropdown');
            dropdown.classList.remove('show');
        }

        function selecionarProduto(produto) {
            const jaAdicionado = produtosSelecionados.some(p => p.url === produto.url);
            
            if (jaAdicionado) {
                mostrarMensagem('Este produto j√° foi adicionado', 'erro');
                esconderSugestoes();
                document.getElementById('termoBusca').value = '';
                return;
            }

            produto.is_clube = false;
            produto.is_exclusivo = false;
            produto.is_oferta_relampago = false;
            produtosSelecionados.push(produto);
            renderizarProdutos();
            document.getElementById('termoBusca').value = '';
            esconderSugestoes();
            mostrarMensagem('Produto adicionado com sucesso!', 'sucesso');
        }

        async function adicionarProdutoPorUrl() {
            const termo = document.getElementById('termoBusca').value.trim();
            
            if (!termo) {
                mostrarMensagem('Digite um SKU, EAN ou URL', 'erro');
                return;
            }

            if (termo.startsWith('http')) {
                try {
                    const response = await fetch('/buscar-produto', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ termo })
                    });

                    const data = await response.json();

                    if (data.success) {
                        const jaAdicionado = produtosSelecionados.some(p => p.url === data.produto.url);
                        
                        if (jaAdicionado) {
                            mostrarMensagem('Este produto j√° foi adicionado', 'erro');
                            return;
                        }

                        data.produto.is_clube = false;
                        data.produto.is_exclusivo = false;
                        produtosSelecionados.push(data.produto);
                        renderizarProdutos();
                        document.getElementById('termoBusca').value = '';
                        esconderSugestoes();
                        mostrarMensagem('Produto adicionado com sucesso!', 'sucesso');
                    } else {
                        mostrarMensagem(data.error || '‚úó Produto n√£o encontrado', 'erro');
                    }
                } catch (error) {
                    mostrarMensagem('Erro ao buscar produto', 'erro');
                    console.error('Erro na busca:', error);
                }
            } else {
                mostrarMensagem('Use as sugest√µes ou cole uma URL completa', 'info');
            }
        }

        function removerProduto(index) {
            const nomeProduto = produtosSelecionados[index].nome;
            produtosSelecionados.splice(index, 1);
            renderizarProdutos();
            mostrarMensagem(`Produto removido: ${nomeProduto.substring(0, 40)}...`, 'sucesso');
        }

        document.getElementById('termoBusca').addEventListener('input', function(e) {
            const termo = e.target.value.trim();
            
            if (timeoutBusca) {
                clearTimeout(timeoutBusca);
            }

            timeoutBusca = setTimeout(() => {
                buscarSugestoes(termo);
            }, 100);
        });

        document.addEventListener('click', function(e) {
            const searchBox = document.querySelector('.search-box');
            if (!searchBox.contains(e.target)) {
                esconderSugestoes();
            }
        });

        document.getElementById('termoBusca').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const termo = e.target.value.trim();
                if (termo.startsWith('http')) {
                    adicionarProdutoPorUrl();
                }
            }
        });

        document.getElementById('formGerador').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (produtosSelecionados.length === 0) {
                mostrarMensagem('Adicione pelo menos um produto', 'erro');
                return;
            }

            const corBotao = document.getElementById('cor_botao_hex').value.trim();
            if (!/^#[0-9A-Fa-f]{6}$/.test(corBotao)) {
                mostrarMensagem('Cor do bot√£o inv√°lida. Use formato hexadecimal (#RRGGBB)', 'erro');
                document.getElementById('cor_botao_hex').focus();
                return;
            }

            const ctaUrl = document.getElementById('cta_url').value.trim();
            if (!ctaUrl || !ctaUrl.startsWith('http')) {
                mostrarMensagem('URL do CTA inv√°lida. Use uma URL completa come√ßando com http:// ou https://', 'erro');
                document.getElementById('cta_url').focus();
                return;
            }

            const preheaderText = document.getElementById('preheader_text').value.trim();

            const loading = document.getElementById('loading');
            const btnGerar = document.getElementById('btnGerar');
            
            loading.classList.add('show');
            btnGerar.disabled = true;

            const produtosComClube = produtosSelecionados.map((produto, index) => {
                const checkboxClube = document.querySelector(`.checkbox-clube[data-index="${index}"]`);
                const checkboxExclusivo = document.querySelector(`.checkbox-exclusivo[data-index="${index}"]`);
                const checkboxRelampago = document.querySelector(`.checkbox-relampago[data-index="${index}"]`);
                return {
                    ...produto,
                    is_clube: checkboxClube ? checkboxClube.checked : false,
                    is_exclusivo: checkboxExclusivo ? checkboxExclusivo.checked : false,
                    is_oferta_relampago: checkboxRelampago ? checkboxRelampago.checked : false
                };
            });
            // Captura o valor do cupom selecionado
            const cupomSelecionado = document.getElementById('componente_bloco_cupom').value || '';
            const apenasProdutos = document.getElementById('apenas_produtos').value || '';

            const dados = {
                produtos: produtosComClube,
                utm_source: document.getElementById('utm_source').value,
                utm_campaign: document.getElementById('utm_campaign').value,
                cta_url: ctaUrl,
                preheader_text: preheaderText,
                apenas_produtos: apenasProdutos,
                componente_bloco_03: document.getElementById('componente_bloco_03').value,
                componente_bloco_05: document.getElementById('componente_bloco_05').value,
                componente_bloco_cupom: cupomSelecionado,
                cor_botao: corBotao
            };

            try {
                const response = await fetch('/gerar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dados)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Erro HTTP ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    mostrarMensagem('Email gerado com sucesso!', 'sucesso');
                    setTimeout(() => {
                        sessionStorage.setItem('emailGerado', result.html);
                        window.location.href = '/resultado';
                    }, 1000);
                } else {
                    mostrarMensagem(result.error || 'Erro ao gerar email', 'erro');
                }
            } catch (error) {
                console.error('Erro completo:', error);
                mostrarMensagem(`‚úó ${error.message}`, 'erro');
            } finally {
                loading.classList.remove('show');
                btnGerar.disabled = false;
            }
        });

        // Inicializar preview vazio
        atualizarPreview();

        function toggleCupom() {
            const toggle = document.getElementById('toggle-cupom');
            const hiddenInput = document.getElementById('componente_bloco_cupom');
            const toggleApenasProdutos = document.getElementById('toggle-apenas-produtos');
            
            if (toggle.checked) {
                hiddenInput.value = 'bloco_cupom_explicativo';
                // Se cupom for ativado, desativa "apenas produtos"
                if (toggleApenasProdutos.checked) {
                    toggleApenasProdutos.checked = false;
                    document.getElementById('apenas_produtos').value = '';
                }
            } else {
                hiddenInput.value = '';
            }
            
            atualizarPreview();
        }

        function toggleApenasProdutos() {
            const toggle = document.getElementById('toggle-apenas-produtos');
            const hiddenInput = document.getElementById('apenas_produtos');
            const preheaderInput = document.getElementById('preheader_text');
            
            if (toggle.checked) {
                // Ativa modo "apenas produtos"
                hiddenInput.value = 'true';
                
                // Desativa e desabilita todos os outros componentes
                document.getElementById('componente_bloco_03').value = '';
                document.getElementById('componente_bloco_05').value = '';
                document.getElementById('componente_bloco_cupom').value = '';
                document.getElementById('toggle-cupom').checked = false;
                
                // Desabilita o campo de preheader
                preheaderInput.disabled = true;
                preheaderInput.style.opacity = '0.5';
                preheaderInput.style.cursor = 'not-allowed';
                
                // Reseta os dropdowns visuais
                document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
                    const selectedText = dropdown.querySelector('.selected-text');
                    const options = dropdown.querySelectorAll('.dropdown-option');
                    
                    selectedText.textContent = 'Nenhum banner';
                    options.forEach(opt => opt.classList.remove('selected'));
                    options[0].classList.add('selected'); // Primeira op√ß√£o (Nenhum)
                });
                
                // Desabilita visualmente os controles
                desabilitarComponentes(true);
            } else {
                // Desativa modo "apenas produtos"
                hiddenInput.value = '';
                
                // Reabilita os controles
                desabilitarComponentes(false);
            }
            
            atualizarPreview();
        }

        function desabilitarComponentes(desabilitar) {
            const dropdowns = document.querySelectorAll('.custom-dropdown');
            const toggleCupom = document.getElementById('toggle-cupom');
            const labelCupom = document.querySelector('label[for="toggle-cupom"]');
            const preheaderInput = document.getElementById('preheader_text');
            const preheaderLabel = preheaderInput.previousElementSibling; // pega o label
            
            dropdowns.forEach(dropdown => {
                if (desabilitar) {
                    dropdown.style.opacity = '0.5';
                    dropdown.style.pointerEvents = 'none';
                } else {
                    dropdown.style.opacity = '1';
                    dropdown.style.pointerEvents = 'auto';
                }
            });
            
            if (desabilitar) {
                toggleCupom.disabled = true;
                labelCupom.style.opacity = '0.5';
                preheaderInput.disabled = true;
                preheaderInput.style.opacity = '0.5';
                preheaderLabel.style.opacity = '0.5';
            } else {
                toggleCupom.disabled = false;
                labelCupom.style.opacity = '1';
                preheaderInput.disabled = false;
                preheaderInput.style.opacity = '1';
                preheaderLabel.style.opacity = '1';
            }
        }

        // Inicializa os dropdowns customizados
        function initCustomDropdowns() {
            document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
                const selected = dropdown.querySelector('.custom-dropdown-selected');
                const optionsContainer = dropdown.querySelector('.custom-dropdown-options');
                const options = dropdown.querySelectorAll('.dropdown-option');
                const hiddenInput = dropdown.querySelector('input[type="hidden"]');
                const dropdownId = dropdown.dataset.dropdown;
                
                // Toggle dropdown ao clicar
                selected.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    // Fecha outros dropdowns abertos
                    document.querySelectorAll('.custom-dropdown').forEach(d => {
                        if (d !== dropdown) {
                            d.classList.remove('open');
                        }
                    });
                    
                    dropdown.classList.toggle('open');
                });
                
                // Selecionar op√ß√£o
                options.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        
                        const value = option.dataset.value;
                        const text = option.querySelector('.option-text').textContent;
                        
                        // Se algum banner for selecionado, desativa "apenas produtos"
                        if (value !== '') {
                            const toggleApenasProdutos = document.getElementById('toggle-apenas-produtos');
                            if (toggleApenasProdutos.checked) {
                                toggleApenasProdutos.checked = false;
                                document.getElementById('apenas_produtos').value = '';
                            }
                        }
                        
                        // Atualiza o texto selecionado
                        const selectedTextEl = selected.querySelector('.selected-text');
                        selectedTextEl.textContent = text;
                        selectedTextEl.setAttribute('title', text);
                        
                        // Atualiza o input hidden
                        hiddenInput.value = value;
                        
                        // Remove sele√ß√£o anterior
                        options.forEach(opt => opt.classList.remove('selected'));
                        
                        // Adiciona sele√ß√£o na op√ß√£o clicada
                        option.classList.add('selected');
                        
                        // Fecha o dropdown
                        dropdown.classList.remove('open');
                        
                        // Atualiza preview
                        atualizarPreview();
                    });
                });
            });
            
            // Fecha dropdown ao clicar fora
            document.addEventListener('click', () => {
                document.querySelectorAll('.custom-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('open');
                });
            });
        }
        
        // Chamar ap√≥s o DOM carregar
        document.addEventListener('DOMContentLoaded', () => {
            initCustomDropdowns();
        });
    </script>
</body>
</html>